

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HamGNN_v_2_0.models.HamGNN.net &mdash; HamGNN 2.0 文档</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=8ba3eb92"></script>
      <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/translations.js?v=beaddf03"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            HamGNN
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">API 文档</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/main_entry.html">主程序入口</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/model_structure.html">模型顶层结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/gnn_core.html">GNN 核心层</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/model_components.html">模型通用组件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/data_processing.html">数据处理与输入</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/utilities.html">通用工具函数</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">HamGNN</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">模块代码</a></li>
      <li class="breadcrumb-item active">HamGNN_v_2_0.models.HamGNN.net</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>HamGNN_v_2_0.models.HamGNN.net 源代码</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Descripttion: </span>
<span class="sd">version: </span>
<span class="sd">Author: Yang Zhong</span>
<span class="sd">Date: 2024-08-24 16:14:48</span>
<span class="sd">LastEditors: Yang Zhong</span>
<span class="sd">LastEditTime: 2025-06-09 14:13:10</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.BaseModel</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">e3nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">o3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianSmearing</span><span class="p">,</span> <span class="n">BesselBasis</span><span class="p">,</span> <span class="n">cuttoff_envelope</span><span class="p">,</span> <span class="n">CosineCutoff</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..basis</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExponentialGaussianRadialBasisFunctions</span><span class="p">,</span> 
    <span class="n">ExponentialBernsteinRadialBasisFunctions</span><span class="p">,</span>
    <span class="n">GaussianRadialBasisFunctions</span><span class="p">,</span>
    <span class="n">BernsteinRadialBasisFunctions</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..Toolbox.nequip.nn.embedding</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">OneHotAtomEncoding</span><span class="p">,</span>
    <span class="n">SphericalHarmonicEdgeAttrs</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..Toolbox.nequip.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">AtomwiseLinear</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..Toolbox.nequip.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">AtomicDataDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.Attention_kan</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">RadialBasisEdgeEncoding</span><span class="p">,</span>
                            <span class="n">AttentionBlockE3</span><span class="p">,</span> 
                            <span class="n">PairInteractionBlock</span><span class="p">,</span> 
                            <span class="n">PairInteractionEmbeddingBlock</span><span class="p">,</span>
                            <span class="n">CorrProductBlock</span><span class="p">,</span> 
                            <span class="n">HamLayer</span><span class="p">,</span> 
                            <span class="n">ConvBlockE3</span><span class="p">,</span>  
                            <span class="n">ClebschGordanCoefficients</span><span class="p">,</span>
                            <span class="n">SoftUnitStepCutoff</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.core.periodic_table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Element</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.clebsch_gordan</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClebschGordan</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..e3_layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">e3TensorDecomp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span><span class="o">,</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">easydict</span><span class="w"> </span><span class="kn">import</span> <span class="n">EasyDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch_scatter</span><span class="w"> </span><span class="kn">import</span> <span class="n">scatter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">opt_einsum</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">oe</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.kpoint_gen</span><span class="w"> </span><span class="kn">import</span> <span class="n">kpoints_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.core.structure</span><span class="w"> </span><span class="kn">import</span> <span class="n">Structure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.symmetry.kpath</span><span class="w"> </span><span class="kn">import</span> <span class="n">KPathSeek</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">e3nn.math</span><span class="w"> </span><span class="kn">import</span> <span class="n">soft_unit_step</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">blockwise_2x2_concat</span><span class="p">,</span> <span class="n">extract_elements_above_threshold</span><span class="p">,</span> <span class="n">upgrade_tensor_precision</span>

<span class="n">au2ang</span> <span class="o">=</span> <span class="mf">0.5291772083</span>

<div class="viewcode-block" id="HamGNNConvE3">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNConvE3">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HamGNNConvE3</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;基于 E(3) 等变图卷积的 HamGNN 模型。</span>

<span class="sd">    该模型通过堆叠多个等变卷积层来学习原子及其相互作用的表示。</span>
<span class="sd">    每一层都会更新原子（节点）和原子对（边）的特征，同时严格保持在旋转下的等变性。</span>
<span class="sd">    最终输出节点和边的等变特征，用于后续的物理属性预测。</span>

<span class="sd">    Attributes:</span>
<span class="sd">        num_types (int): 系统中原子种类的数量。</span>
<span class="sd">        cutoff (float): 径向截断半径。</span>
<span class="sd">        num_layers (int): 等变卷积层的数量。</span>
<span class="sd">        irreps_node_features (o3.Irreps): 节点特征的不可约表示。</span>
<span class="sd">        radial_basis_functions (nn.Module): 径向基函数模块。</span>
<span class="sd">        atomic_embedding (nn.Module): 将原子种类转换为独热编码的模块。</span>
<span class="sd">        spharm_edges (nn.Module): 计算边向量的球谐函数的模块。</span>
<span class="sd">        radial_basis (nn.Module): 编码边长度的径向基函数模块。</span>
<span class="sd">        pair_embedding (nn.Module): 嵌入原子对相互作用的初始特征。</span>
<span class="sd">        chemical_embedding (nn.Module): 将独热编码嵌入到初始节点特征中。</span>
<span class="sd">        convolutions (nn.ModuleList): 等变卷积层列表。</span>
<span class="sd">        corr_products (nn.ModuleList): （可选）相关性乘积层列表。</span>
<span class="sd">        pair_interactions (nn.ModuleList): 原子对相互作用层列表。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            config (EasyDict): </span>
<span class="sd">                包含模型配置参数的对象。关键属性包括：</span>

<span class="sd">                - HamGNN_pre.radius_type (str): 用于确定邻居的半径类型。</span>
<span class="sd">                - HamGNN_pre.radius_scale (float): 内部图构建时的半径缩放因子，必须大于1.0。</span>
<span class="sd">                - HamGNN_pre.num_types (int): 原子种类的总数。</span>
<span class="sd">                - HamGNN_pre.irreps_edge_sh (str): 边球谐函数的不可约表示。</span>
<span class="sd">                - HamGNN_pre.edge_sh_normalization (str): 球谐函数的归一化方式 (&#39;component&#39; 或 &#39;norm&#39;)。</span>
<span class="sd">                - HamGNN_pre.edge_sh_normalize (bool): 是否对球谐函数进行归一化。</span>
<span class="sd">                - HamGNN_pre.build_internal_graph (bool): 是否在模型内部动态构建图。</span>
<span class="sd">                - HamGNN_pre.use_corr_prod (bool): 是否使用相关性乘积块。</span>
<span class="sd">                - HamGNN_pre.cutoff (float): 截断半径。</span>
<span class="sd">                - HamGNN_pre.rbf_func (str): 径向基函数的类型 (例如, &#39;gaussian&#39;, &#39;bessel&#39;)。</span>
<span class="sd">                - HamGNN_pre.num_radial (int): 径向基函数的数量。</span>
<span class="sd">                - HamGNN_pre.num_layers (int): 卷积层数。</span>
<span class="sd">                - HamGNN_pre.irreps_node_features (str): 节点特征的不可约表示。</span>
<span class="sd">                - HamGNN_pre.use_kan (bool): 是否在 MLP 中使用 KAN (Kolmogorov-Arnold Networks) 层。</span>
<span class="sd">                - HamGNN_pre.radial_MLP (list): 径向 MLP 的隐藏层维度。</span>
<span class="sd">                - HamGNN_pre.correlation (int): 相关性乘积块中的相关性阶数。</span>
<span class="sd">                - HamGNN_pre.num_hidden_features (int): 相关性乘积块中的隐藏特征数。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;radius_scale&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">radius_scale</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">radius_scale</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;半径缩放因子必须大于 1.0。&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">radius_type</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">radius_type</span><span class="p">,</span> <span class="n">radius_scale</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">radius_scale</span><span class="p">)</span>
        
        <span class="c1"># --- 配置设定 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_types</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">num_types</span>  <span class="c1"># 原子种类数量</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_features</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 是否将独热编码设置为节点特征</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irreps_edge_sh</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">irreps_edge_sh</span><span class="p">)</span>  <span class="c1"># 边球谐函数的不可约表示</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_sh_normalization</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">edge_sh_normalization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_sh_normalize</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">edge_sh_normalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_internal_graph</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">build_internal_graph</span>
        <span class="k">if</span> <span class="s1">&#39;use_corr_prod&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_corr_prod</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_corr_prod</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">use_corr_prod</span>
        
        <span class="c1"># --- 径向基函数 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">rbf_func</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_radial</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">num_radial</span>                
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis_functions</span> <span class="o">=</span> <span class="n">GaussianSmearing</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">num_gaussians</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_radial</span><span class="p">,</span> <span class="n">cutoff_func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span> <span class="o">==</span> <span class="s1">&#39;bessel&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis_functions</span> <span class="o">=</span> <span class="n">BesselBasis</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">n_rbf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_radial</span><span class="p">,</span> <span class="n">cutoff_func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span> <span class="o">==</span> <span class="s1">&#39;exp-gaussian&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis_functions</span> <span class="o">=</span> <span class="n">ExponentialGaussianRadialBasisFunctions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_radial</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span> <span class="o">==</span> <span class="s1">&#39;exp-bernstein&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis_functions</span> <span class="o">=</span> <span class="n">ExponentialBernsteinRadialBasisFunctions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_radial</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span> <span class="o">==</span> <span class="s1">&#39;bernstein&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis_functions</span> <span class="o">=</span> <span class="n">BernsteinRadialBasisFunctions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_radial</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;不支持的径向基函数: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">num_layers</span>  <span class="c1"># 卷积层数量</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">)</span>  <span class="c1"># 节点特征的不可约表示</span>
        
        <span class="c1"># --- 原子嵌入模块 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span> <span class="o">=</span> <span class="n">OneHotAtomEncoding</span><span class="p">(</span><span class="n">num_types</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_types</span><span class="p">,</span> <span class="n">set_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">set_features</span><span class="p">)</span>
        
        <span class="c1"># --- 边向量的球谐函数 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spharm_edges</span> <span class="o">=</span> <span class="n">SphericalHarmonicEdgeAttrs</span><span class="p">(</span><span class="n">irreps_edge_sh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_edge_sh</span><span class="p">,</span> 
                                                       <span class="n">edge_sh_normalization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_sh_normalization</span><span class="p">,</span>
                                                       <span class="n">edge_sh_normalize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_sh_normalize</span><span class="p">)</span>
        
        <span class="c1"># --- 边长度的径向基函数 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_func</span> <span class="o">=</span> <span class="n">CosineCutoff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis</span> <span class="o">=</span> <span class="n">RadialBasisEdgeEncoding</span><span class="p">(</span><span class="n">basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_basis_functions</span><span class="p">,</span> 
                                                    <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff_func</span><span class="p">)</span>

       <span class="c1"># --- 边特征嵌入模块 ---</span>
        <span class="n">use_kan</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">use_kan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radial_MLP</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">radial_MLP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_embedding</span> <span class="o">=</span> <span class="n">PairInteractionEmbeddingBlock</span><span class="p">(</span><span class="n">irreps_node_feats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="s1">&#39;node_attrs&#39;</span><span class="p">],</span>
                                        <span class="n">irreps_edge_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spharm_edges</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_ATTRS_KEY</span><span class="p">],</span>
                                        <span class="n">irreps_edge_embed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_basis</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_EMBEDDING_KEY</span><span class="p">],</span>
                                        <span class="n">irreps_edge_feats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">,</span>
                                        <span class="n">irreps_node_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="s1">&#39;node_attrs&#39;</span><span class="p">],</span>
                                        <span class="n">use_kan</span><span class="o">=</span><span class="n">use_kan</span><span class="p">,</span>
                                        <span class="n">radial_MLP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_MLP</span><span class="p">)</span>
        
        <span class="c1"># --- 原子化学环境嵌入 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chemical_embedding</span> <span class="o">=</span> <span class="n">AtomwiseLinear</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="p">{</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">NODE_FEATURES_KEY</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="s1">&#39;node_attrs&#39;</span><span class="p">]},</span> 
                                                 <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">)</span>
        
        <span class="c1"># --- 定义卷积层、相关性乘积层和原子对相互作用层 ---</span>
        <span class="n">correlation</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">correlation</span>
        <span class="n">num_hidden_features</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">num_hidden_features</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">convolutions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_corr_prod</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">corr_products</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_interactions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span><span class="p">):</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="n">ConvBlockE3</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">,</span>
                                               <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">,</span>
                                               <span class="n">irreps_node_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="s1">&#39;node_attrs&#39;</span><span class="p">],</span>
                                               <span class="n">irreps_edge_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spharm_edges</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_ATTRS_KEY</span><span class="p">],</span>                      
                                               <span class="n">irreps_edge_embed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_basis</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_EMBEDDING_KEY</span><span class="p">],</span>
                                               <span class="n">radial_MLP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_MLP</span><span class="p">,</span>
                                               <span class="n">use_skip_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                               <span class="n">use_kan</span><span class="o">=</span><span class="n">use_kan</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convolutions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_corr_prod</span><span class="p">:</span>
                <span class="n">corr_product</span> <span class="o">=</span> <span class="n">CorrProductBlock</span><span class="p">(</span>
                    <span class="n">irreps_node_feats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">,</span>
                    <span class="n">num_hidden_features</span><span class="o">=</span><span class="n">num_hidden_features</span><span class="p">,</span>
                    <span class="n">correlation</span><span class="o">=</span><span class="n">correlation</span><span class="p">,</span>
                    <span class="n">num_elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_types</span><span class="p">,</span>
                    <span class="n">use_skip_connections</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">corr_products</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corr_product</span><span class="p">)</span>

            <span class="n">pair_interaction</span> <span class="o">=</span> <span class="n">PairInteractionBlock</span><span class="p">(</span><span class="n">irreps_node_feats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">,</span>
                                                    <span class="n">irreps_node_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="s1">&#39;node_attrs&#39;</span><span class="p">],</span>
                                                    <span class="n">irreps_edge_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spharm_edges</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_ATTRS_KEY</span><span class="p">],</span>
                                                    <span class="n">irreps_edge_embed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_basis</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_EMBEDDING_KEY</span><span class="p">],</span>
                                                    <span class="n">irreps_edge_feats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">,</span>
                                                    <span class="n">use_skip_connections</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">use_kan</span><span class="o">=</span><span class="n">use_kan</span><span class="p">,</span>
                                                    <span class="n">radial_MLP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_MLP</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pair_interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair_interaction</span><span class="p">)</span>
    
<div class="viewcode-block" id="HamGNNConvE3.forward">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNConvE3.forward">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;执行模型的前向传播。</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Data or EasyDict): </span>
<span class="sd">                输入的图数据对象，遵循 PyG 或 Nequip 的数据格式。</span>
<span class="sd">                需要包含 `pos`, `z`, `edge_index` 等原子结构信息。</span>

<span class="sd">        Returns:</span>
<span class="sd">            EasyDict:</span>
<span class="sd">                一个包含最终节点和边等变特征的字典。</span>
<span class="sd">                - &#39;node_attr&#39;: 节点的等变特征张量。</span>
<span class="sd">                - &#39;edge_attr&#39;: 边的等变特征张量。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">()</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
            <span class="n">upgrade_tensor_precision</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># 如果配置要求，则在模型内部构建图（邻接关系）</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_internal_graph</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_graph</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="n">data</span>
        
        <span class="c1"># --- 特征提取与嵌入 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>  <span class="c1"># 原子种类独热编码</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spharm_edges</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>      <span class="c1"># 边向量的球谐函数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>      <span class="c1"># 边长度的径向基</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_embedding</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>    <span class="c1"># 原子对特征嵌入</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chemical_embedding</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span><span class="c1"># 初始化学环境特征</span>
        
        <span class="c1"># --- 等变卷积层堆叠 ---</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convolutions</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">graph</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_corr_prod</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">corr_products</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">graph</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pair_interactions</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">graph</span><span class="p">)</span>
            
        <span class="c1"># --- 整理并返回最终的图表示 ---</span>
        <span class="n">graph_representation</span> <span class="o">=</span> <span class="n">EasyDict</span><span class="p">()</span>
        <span class="n">graph_representation</span><span class="p">[</span><span class="s1">&#39;node_attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">NODE_FEATURES_KEY</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_internal_graph</span><span class="p">:</span>
            <span class="c1"># 如果是内部生成的图，需要匹配正确的边</span>
            <span class="n">graph_representation</span><span class="p">[</span><span class="s1">&#39;edge_attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_FEATURES_KEY</span><span class="p">][</span><span class="n">graph</span><span class="o">.</span><span class="n">matching_edges</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">graph_representation</span><span class="p">[</span><span class="s1">&#39;edge_attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_FEATURES_KEY</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">graph_representation</span></div>
</div>



<div class="viewcode-block" id="HamGNNTransformer">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNTransformer">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HamGNNTransformer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;基于 E(3) 等变 Transformer 的 HamGNN 模型。</span>

<span class="sd">    该模型采用等变自注意力机制来捕捉原子间的相互作用，替代了传统的卷积操作。</span>
<span class="sd">    它允许模型在更新节点特征时，动态地权衡来自不同邻居的信息。</span>
<span class="sd">    模型的整体结构与 `HamGNNConvE3` 相似，但核心交互层换成了 `AttentionBlockE3`。</span>

<span class="sd">    Attributes:</span>
<span class="sd">        num_types (int): 系统中原子种类的数量。</span>
<span class="sd">        cutoff (float): 径向截断半径。</span>
<span class="sd">        num_layers (int): 等变 Transformer 层的数量。</span>
<span class="sd">        irreps_node_features (o3.Irreps): 节点特征的不可约表示。</span>
<span class="sd">        num_heads (int): 自注意力机制中的头数。</span>
<span class="sd">        radial_basis_functions (nn.Module): 径向基函数模块。</span>
<span class="sd">        atomic_embedding (nn.Module): 将原子种类转换为独热编码的模块。</span>
<span class="sd">        spharm_edges (nn.Module): 计算边向量的球谐函数的模块。</span>
<span class="sd">        radial_basis (nn.Module): 编码边长度的径向基函数模块。</span>
<span class="sd">        pair_embedding (nn.Module): 嵌入原子对相互作用的初始特征。</span>
<span class="sd">        chemical_embedding (nn.Module): 将独热编码嵌入到初始节点特征中。</span>
<span class="sd">        orb_transformers (nn.ModuleList): 等变 Transformer 层列表。</span>
<span class="sd">        corr_products (nn.ModuleList): 相关性乘积层列表。</span>
<span class="sd">        pair_interactions (nn.ModuleList): 原子对相互作用层列表。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            config (EasyDict): </span>
<span class="sd">                包含模型配置参数的对象。关键属性包括：</span>

<span class="sd">                - HamGNN_pre.radius_type (str): 用于确定邻居的半径类型。</span>
<span class="sd">                - HamGNN_pre.radius_scale (float): 内部图构建时的半径缩放因子，必须大于1.0。</span>
<span class="sd">                - HamGNN_pre.num_types (int): 原子种类的总数。</span>
<span class="sd">                - HamGNN_pre.irreps_edge_sh (str): 边球谐函数的不可约表示。</span>
<span class="sd">                - HamGNN_pre.edge_sh_normalization (str): 球谐函数的归一化方式 (&#39;component&#39; 或 &#39;norm&#39;)。</span>
<span class="sd">                - HamGNN_pre.edge_sh_normalize (bool): 是否对球谐函数进行归一化。</span>
<span class="sd">                - HamGNN_pre.build_internal_graph (bool): 是否在模型内部动态构建图。</span>
<span class="sd">                - HamGNN_pre.cutoff (float): 截断半径。</span>
<span class="sd">                - HamGNN_pre.rbf_func (str): 径向基函数的类型 (例如, &#39;gaussian&#39;, &#39;bessel&#39;)。</span>
<span class="sd">                - HamGNN_pre.num_radial (int): 径向基函数的数量。</span>
<span class="sd">                - HamGNN_pre.num_layers (int): Transformer 层数。</span>
<span class="sd">                - HamGNN_pre.irreps_node_features (str): 节点特征的不可约表示。</span>
<span class="sd">                - HamGNN_pre.num_heads (int): 注意力头的数量。</span>
<span class="sd">                - HamGNN_pre.use_kan (bool): 是否在 MLP 中使用 KAN (Kolmogorov-Arnold Networks) 层。</span>
<span class="sd">                - HamGNN_pre.radial_MLP (list): 径向 MLP 的隐藏层维度。</span>
<span class="sd">                - HamGNN_pre.correlation (int): 相关性乘积块中的相关性阶数。</span>
<span class="sd">                - HamGNN_pre.num_hidden_features (int): 相关性乘积块中的隐藏特征数。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;radius_scale&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">radius_scale</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">radius_scale</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;半径缩放因子必须大于 1.0。&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">radius_type</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">radius_type</span><span class="p">,</span> <span class="n">radius_scale</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">radius_scale</span><span class="p">)</span>
        
        <span class="c1"># --- 配置设定 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_types</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">num_types</span>  <span class="c1"># 原子种类数量</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_features</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 是否将独热编码设置为节点特征</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irreps_edge_sh</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">irreps_edge_sh</span><span class="p">)</span>  <span class="c1"># 边球谐函数的不可约表示</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_sh_normalization</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">edge_sh_normalization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_sh_normalize</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">edge_sh_normalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_internal_graph</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">build_internal_graph</span>

        <span class="c1"># --- 径向基函数 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">rbf_func</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_radial</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">num_radial</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis_functions</span> <span class="o">=</span> <span class="n">GaussianSmearing</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">num_gaussians</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_radial</span><span class="p">,</span> <span class="n">cutoff_func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span> <span class="o">==</span> <span class="s1">&#39;bessel&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis_functions</span> <span class="o">=</span> <span class="n">BesselBasis</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">n_rbf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_radial</span><span class="p">,</span> <span class="n">cutoff_func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span> <span class="o">==</span> <span class="s1">&#39;exp-gaussian&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis_functions</span> <span class="o">=</span> <span class="n">ExponentialGaussianRadialBasisFunctions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_radial</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span> <span class="o">==</span> <span class="s1">&#39;exp-bernstein&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis_functions</span> <span class="o">=</span> <span class="n">ExponentialBernsteinRadialBasisFunctions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_radial</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span> <span class="o">==</span> <span class="s1">&#39;bernstein&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis_functions</span> <span class="o">=</span> <span class="n">BernsteinRadialBasisFunctions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_radial</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;不支持的径向基函数: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rbf_func</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">num_layers</span>  <span class="c1"># Transformer 层数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">)</span>  <span class="c1"># 节点特征的不可约表示</span>
        
        <span class="c1"># --- 原子嵌入模块 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span> <span class="o">=</span> <span class="n">OneHotAtomEncoding</span><span class="p">(</span><span class="n">num_types</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_types</span><span class="p">,</span> <span class="n">set_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">set_features</span><span class="p">)</span>
        
        <span class="c1"># --- 边向量的球谐函数 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spharm_edges</span> <span class="o">=</span> <span class="n">SphericalHarmonicEdgeAttrs</span><span class="p">(</span><span class="n">irreps_edge_sh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_edge_sh</span><span class="p">,</span> 
                                                       <span class="n">edge_sh_normalization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_sh_normalization</span><span class="p">,</span>
                                                       <span class="n">edge_sh_normalize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_sh_normalize</span><span class="p">)</span>
        
        <span class="c1"># --- 边长度的径向基函数 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_func</span> <span class="o">=</span> <span class="n">CosineCutoff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis</span> <span class="o">=</span> <span class="n">RadialBasisEdgeEncoding</span><span class="p">(</span><span class="n">basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_basis_functions</span><span class="p">,</span> 
                                                    <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff_func</span><span class="p">)</span>
        
        <span class="c1"># --- 边特征嵌入模块 ---</span>
        <span class="n">use_kan</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">use_kan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radial_MLP</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">radial_MLP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_embedding</span> <span class="o">=</span> <span class="n">PairInteractionEmbeddingBlock</span><span class="p">(</span><span class="n">irreps_node_feats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="s1">&#39;node_attrs&#39;</span><span class="p">],</span>
                                        <span class="n">irreps_edge_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spharm_edges</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_ATTRS_KEY</span><span class="p">],</span>
                                        <span class="n">irreps_edge_embed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_basis</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_EMBEDDING_KEY</span><span class="p">],</span>
                                        <span class="n">irreps_edge_feats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">,</span>
                                        <span class="n">irreps_node_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="s1">&#39;node_attrs&#39;</span><span class="p">],</span>
                                        <span class="n">use_kan</span><span class="o">=</span><span class="n">use_kan</span><span class="p">,</span>
                                        <span class="n">radial_MLP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_MLP</span><span class="p">)</span>
        
        <span class="c1"># --- 原子化学环境嵌入 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chemical_embedding</span> <span class="o">=</span> <span class="n">AtomwiseLinear</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="p">{</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">NODE_FEATURES_KEY</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="s1">&#39;node_attrs&#39;</span><span class="p">]},</span> 
                                                 <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">)</span>
        
        <span class="c1"># --- 定义 Transformer 层 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">num_heads</span>
        <span class="n">correlation</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">correlation</span>
        <span class="n">num_hidden_features</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HamGNN_pre</span><span class="o">.</span><span class="n">num_hidden_features</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">orb_transformers</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr_products</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_interactions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span><span class="p">):</span>
            <span class="n">orb_transformer</span> <span class="o">=</span> <span class="n">AttentionBlockE3</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">,</span>
                                               <span class="n">irreps_node_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="s1">&#39;node_attrs&#39;</span><span class="p">],</span>
                                               <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">,</span>
                                               <span class="n">irreps_edge_feats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">,</span>
                                               <span class="n">irreps_edge_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spharm_edges</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_ATTRS_KEY</span><span class="p">],</span>                      
                                               <span class="n">irreps_edge_embed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_basis</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_EMBEDDING_KEY</span><span class="p">],</span>
                                               <span class="n">num_heads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">,</span> 
                                               <span class="n">max_radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
                                               <span class="n">radial_MLP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_MLP</span><span class="p">,</span>
                                               <span class="n">use_skip_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                               <span class="n">use_kan</span><span class="o">=</span><span class="n">use_kan</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orb_transformers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orb_transformer</span><span class="p">)</span>

            <span class="n">corr_product</span> <span class="o">=</span> <span class="n">CorrProductBlock</span><span class="p">(</span>
                <span class="n">irreps_node_feats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">,</span>
                <span class="n">num_hidden_features</span><span class="o">=</span><span class="n">num_hidden_features</span><span class="p">,</span>
                <span class="n">correlation</span><span class="o">=</span><span class="n">correlation</span><span class="p">,</span>
                <span class="n">num_elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_types</span><span class="p">,</span>
                <span class="n">use_skip_connections</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">corr_products</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corr_product</span><span class="p">)</span>

            <span class="n">pair_interaction</span> <span class="o">=</span> <span class="n">PairInteractionBlock</span><span class="p">(</span><span class="n">irreps_node_feats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">,</span>
                                                    <span class="n">irreps_node_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="s1">&#39;node_attrs&#39;</span><span class="p">],</span>
                                                    <span class="n">irreps_edge_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spharm_edges</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_ATTRS_KEY</span><span class="p">],</span>
                                                    <span class="n">irreps_edge_embed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_basis</span><span class="o">.</span><span class="n">irreps_out</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_EMBEDDING_KEY</span><span class="p">],</span>
                                                    <span class="n">irreps_edge_feats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irreps_node_features</span><span class="p">,</span>
                                                    <span class="n">use_skip_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">use_kan</span><span class="o">=</span><span class="n">use_kan</span><span class="p">,</span>
                                                    <span class="n">radial_MLP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radial_MLP</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pair_interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair_interaction</span><span class="p">)</span>
    
<div class="viewcode-block" id="HamGNNTransformer.forward">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNTransformer.forward">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;执行模型的前向传播。</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Data or EasyDict): </span>
<span class="sd">                输入的图数据对象，遵循 PyG 或 Nequip 的数据格式。</span>
<span class="sd">                需要包含 `pos`, `z`, `edge_index` 等原子结构信息。</span>

<span class="sd">        Returns:</span>
<span class="sd">            EasyDict:</span>
<span class="sd">                一个包含最终节点和边等变特征的字典。</span>
<span class="sd">                - &#39;node_attr&#39;: 节点的等变特征张量。</span>
<span class="sd">                - &#39;edge_attr&#39;: 边的等变特征张量。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_internal_graph</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_graph</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="n">data</span>
        
        <span class="c1"># --- 特征提取与嵌入 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atomic_embedding</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spharm_edges</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radial_basis</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_embedding</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chemical_embedding</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

        <span class="c1"># --- 等变 Transformer 层堆叠 ---</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orb_transformers</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">graph</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">corr_products</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">graph</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pair_interactions</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">graph</span><span class="p">)</span>
            
        <span class="c1"># --- 整理并返回最终的图表示 ---</span>
        <span class="n">graph_representation</span> <span class="o">=</span> <span class="n">EasyDict</span><span class="p">()</span>
        <span class="n">graph_representation</span><span class="p">[</span><span class="s1">&#39;node_attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">NODE_FEATURES_KEY</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_internal_graph</span><span class="p">:</span>
            <span class="n">graph_representation</span><span class="p">[</span><span class="s1">&#39;edge_attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_FEATURES_KEY</span><span class="p">][</span><span class="n">graph</span><span class="o">.</span><span class="n">matching_edges</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">graph_representation</span><span class="p">[</span><span class="s1">&#39;edge_attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="n">AtomicDataDict</span><span class="o">.</span><span class="n">EDGE_FEATURES_KEY</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">graph_representation</span></div>
</div>



<div class="viewcode-block" id="HamGNNPlusPlusOut">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HamGNNPlusPlusOut</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HamGNN 的输出模块，用于构建物理哈密顿量并计算相关属性。</span>

<span class="sd">    这个模块接收图神经网络编码的等变特征，并利用这些特征作为系数，</span>
<span class="sd">    通过 Clebsch-Gordan 张量积将它们组合成完整的哈密顿量 (H) 和重叠矩阵 (S)。</span>
<span class="sd">    它能够处理多种 DFT 软件（如 OpenMX, SIESTA, ABACUS）的基组，支持自旋轨道耦合（SOC）、</span>
<span class="sd">    自旋约束计算，并能最终求解能带结构。</span>

<span class="sd">    .. note::</span>
<span class="sd">       这个类的实现非常复杂，因为它紧密地耦合了物理学（量子化学、固体物理）</span>
<span class="sd">       和 E(3) 等变神经网络的数学原理。</span>

<span class="sd">    Attributes:</span>
<span class="sd">        nao_max (int): 预设的最大原子轨道数。</span>
<span class="sd">        ham_type (str): 使用的 DFT 基组类型 (例如 &#39;openmx&#39;)。</span>
<span class="sd">        ham_only (bool): 如果为 True，则只计算哈密顿量，不计算重叠矩阵。</span>
<span class="sd">        soc_switch (bool): 是否启用自旋轨道耦合计算。</span>
<span class="sd">        spin_constrained (bool): 是否进行自旋约束计算。</span>
<span class="sd">        ham_irreps (o3.Irreps): 哈密顿量/重叠矩阵块的不可约表示。</span>
<span class="sd">        onsitenet_h (nn.Module): 用于从节点特征预测 onsite 哈密顿量块的网络。</span>
<span class="sd">        offsitenet_h (nn.Module): 用于从边特征预测 offsite 哈密顿量块的网络。</span>
<span class="sd">        cg_cal (ClebschGordanCoefficients): 用于计算 Clebsch-Gordan 系数的工具。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">irreps_in_node</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">irreps_in_edge</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">nao_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> 
                 <span class="n">return_forces</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">create_graph</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">ham_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;openmx&#39;</span><span class="p">,</span> 
                 <span class="n">ham_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">symmetrize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                 <span class="n">include_triplet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">calculate_band_energy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">num_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> 
                 <span class="n">k_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">band_num_control</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">soc_switch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                 <span class="n">nonlinearity_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;gate&#39;</span><span class="p">,</span> 
                 <span class="n">export_reciprocal_values</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">add_H0</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">soc_basis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;so3&#39;</span><span class="p">,</span>
                 <span class="n">spin_constrained</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">use_learned_weight</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                 <span class="n">minMagneticMoment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> 
                 <span class="n">collinear_spin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">zero_point_shift</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">add_H_nonsoc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">get_nonzero_mask_tensor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            irreps_in_node (o3.Irreps): 输入的节点特征的不可约表示。</span>
<span class="sd">            irreps_in_edge (o3.Irreps): 输入的边特征的不可约表示。</span>
<span class="sd">            nao_max (int): 系统中单个原子的最大轨道数。</span>
<span class="sd">            return_forces (bool): 是否计算并返回力。</span>
<span class="sd">            create_graph (bool): 是否在模块内部创建图。</span>
<span class="sd">            ham_type (str): 哈密顿量的类型，决定了基组的选择 (e.g., &#39;openmx&#39;, &#39;siesta&#39;, &#39;abacus&#39;)。</span>
<span class="sd">            ham_only (bool): 若为 True，则只计算哈密顿量，跳过重叠矩阵。</span>
<span class="sd">            symmetrize (bool): 是否对哈密顿量和重叠矩阵进行对称化处理。</span>
<span class="sd">            include_triplet (bool): 是否包含三体相互作用 (当前未完全实现)。</span>
<span class="sd">            calculate_band_energy (bool): 是否计算能带结构。</span>
<span class="sd">            num_k (int): K 点路径上的采样点数量。</span>
<span class="sd">            k_path (list/np.ndarray): 定义计算能带的高对称 K 点路径。</span>
<span class="sd">            band_num_control (dict): 控制不同原子类型计算的能带数量。</span>
<span class="sd">            soc_switch (bool): 是否启用自旋轨道耦合 (SOC)。</span>
<span class="sd">            nonlinearity_type (str): 在 HamLayer 中使用的非线性激活函数类型 (e.g., &#39;gate&#39;)。</span>
<span class="sd">            export_reciprocal_values (bool): 是否导出倒易空间中的矩阵 (H(k), S(k))。</span>
<span class="sd">            add_H0 (bool): 是否添加一个初始的哈密顿量项 H0。</span>
<span class="sd">            soc_basis (str): SOC 计算使用的基组 (&#39;so3&#39; 或 &#39;su2&#39;)。</span>
<span class="sd">            spin_constrained (bool): 是否进行自旋约束计算。</span>
<span class="sd">            use_learned_weight (bool): 在自旋约束中是否使用可学习的权重。</span>
<span class="sd">            minMagneticMoment (float): 最小磁矩阈值。</span>
<span class="sd">            collinear_spin (bool): 是否处理共线自旋。</span>
<span class="sd">            zero_point_shift (bool): 是否进行零点能量校正。</span>
<span class="sd">            add_H_nonsoc (bool): 是否添加非 SOC 哈密顿量。</span>
<span class="sd">            get_nonzero_mask_tensor (bool): 是否获取非零矩阵元素的掩码张量。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">return_forces</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">derivative</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">derivative</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_graph</span> <span class="o">=</span> <span class="n">create_graph</span>

        <span class="c1"># 确定是否计算力</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_forces</span> <span class="o">=</span> <span class="n">return_forces</span>

        <span class="c1"># 是否在前向传播中创建图</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_graph</span> <span class="o">=</span> <span class="n">create_graph</span>

        <span class="c1"># 原子轨道的最大总数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">=</span> <span class="n">nao_max</span>

        <span class="c1"># 哈密顿量类型</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="o">=</span> <span class="n">ham_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># 是否只计算哈密顿量</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ham_only</span> <span class="o">=</span> <span class="n">ham_only</span>

        <span class="c1"># 是否对称化哈密顿量</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span> <span class="o">=</span> <span class="n">symmetrize</span>

        <span class="c1"># 是否包含三体相互作用</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_triplet</span> <span class="o">=</span> <span class="n">include_triplet</span>

        <span class="c1"># 是否开启自旋轨道耦合</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span> <span class="o">=</span> <span class="n">soc_switch</span>

        <span class="c1"># 非线性激活函数类型</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonlinearity_type</span> <span class="o">=</span> <span class="n">nonlinearity_type</span>

        <span class="c1"># 是否导出倒易空间值</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_reciprocal_values</span> <span class="o">=</span> <span class="n">export_reciprocal_values</span>

        <span class="c1"># 是否添加初始哈密顿项 H0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_H0</span> <span class="o">=</span> <span class="n">add_H0</span>

        <span class="c1"># 自旋约束</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spin_constrained</span> <span class="o">=</span> <span class="n">spin_constrained</span>

        <span class="c1"># 是否使用可学习的哈密顿量权重</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_learned_weight</span> <span class="o">=</span> <span class="n">use_learned_weight</span>

        <span class="c1"># 最小磁矩</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minMagneticMoment</span> <span class="o">=</span> <span class="n">minMagneticMoment</span>

        <span class="c1"># 是否考虑共线自旋</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span> <span class="o">=</span> <span class="n">collinear_spin</span>

        <span class="c1"># 自旋轨道耦合基组</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">=</span> <span class="n">soc_basis</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># 能带结构计算相关参数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energy</span> <span class="o">=</span> <span class="n">calculate_band_energy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span> <span class="o">=</span> <span class="n">num_k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_path</span> <span class="o">=</span> <span class="n">k_path</span>
        
        <span class="c1"># 其他参数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_quartic</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># 其他参数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zero_point_shift</span> <span class="o">=</span> <span class="n">zero_point_shift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_H_nonsoc</span> <span class="o">=</span> <span class="n">add_H_nonsoc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_nonzero_mask_tensor</span> <span class="o">=</span> <span class="n">get_nonzero_mask_tensor</span>

        <span class="c1"># 能带数量控制</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_band_num_control</span><span class="p">(</span><span class="n">band_num_control</span><span class="p">)</span>
        
        <span class="c1"># 初始化基组信息和不可约表示</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_basis_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_irreps</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_cal</span> <span class="o">=</span> <span class="n">ClebschGordanCoefficients</span><span class="p">(</span><span class="n">max_l</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps</span><span class="o">.</span><span class="n">lmax</span><span class="p">)</span>

        <span class="c1"># --- 哈密顿量预测网络 ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps</span><span class="p">)</span>
        
        <span class="c1"># --- SOC 相关网络 ---</span>
        <span class="k">if</span> <span class="n">soc_switch</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="o">!=</span> <span class="s1">&#39;openmx&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">==</span> <span class="s1">&#39;su2&#39;</span>
            
            <span class="c1"># 仅用于测试目的，请谨慎使用！</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">==</span> <span class="s1">&#39;su2&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_su2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_su2</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">==</span> <span class="s1">&#39;so3&#39;</span><span class="p">:</span>                
                <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_ksi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;0e&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">simplify</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_ksi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;0e&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">simplify</span><span class="p">())</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;不支持的 SOC 基组: </span><span class="si">{</span><span class="n">soc_basis</span><span class="si">}</span><span class="s2">！&quot;</span><span class="p">)</span>

        <span class="c1"># --- 自旋约束相关网络 ---</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_constrained</span><span class="p">:</span>
            <span class="c1"># 交换相互作用 J</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">J_irreps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">J_irreps</span><span class="p">)</span>
            
            <span class="c1"># 四阶项 K</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_quartic</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">K_irreps</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">K_irreps</span><span class="p">)</span>
            
            <span class="c1"># 权重矩阵</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_learned_weight</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps</span><span class="p">)</span>
        
        <span class="c1"># --- 重叠矩阵预测网络 ---</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_only</span><span class="p">:</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_ham_layer</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps</span><span class="p">)</span> 
                 
    <span class="k">def</span><span class="w"> </span><span class="nf">_init_irreps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初始化哈密顿量所需的不可约表示 (Irreps)。</span>

<span class="sd">        该方法根据基组定义（`self.row` 和 `self.col`），通过计算轨道角动量</span>
<span class="sd">        `li` 和 `lj` 的所有可能耦合结果 `L`，来构建目标哈密顿量块的 Irreps。</span>
<span class="sd">        这个 Irreps 决定了神经网络需要预测哪些球谐系数。</span>
<span class="sd">        同时，它也为 SOC 和自旋约束情况下的 Irreps 进行初始化。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">()</span>

        <span class="c1"># 遍历所有行列轨道对 (li, lj)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                <span class="c1"># 根据角动量耦合规则，确定输出的 L</span>
                <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="o">-</span><span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="p">),</span> <span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># 宇称为 (-1)^(li+lj)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps</span> <span class="o">+=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irrep</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">irs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">irs</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span><span class="p">)</span>

        <span class="c1"># 如果启用 SOC 且基组为 su2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">==</span> <span class="s1">&#39;su2&#39;</span><span class="p">):</span> 
            <span class="n">out_js_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                    <span class="n">out_js_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hamDecomp</span> <span class="o">=</span> <span class="n">e3TensorDecomp</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_js_list</span><span class="p">,</span> <span class="n">default_dtype_torch</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">nao_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">spinful</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_su2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamDecomp</span><span class="o">.</span><span class="n">required_irreps_out</span>

        <span class="c1"># 如果启用自旋约束</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_constrained</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">K_irreps</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps_dim</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">K_irreps_dim</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nblocks</span> <span class="o">=</span> <span class="mi">0</span>            
            
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Nblocks</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span><span class="p">:</span>
                        <span class="c1"># 对于 SOC，交换相互作用 J 是一个二阶张量 (L=0,1,2)</span>
                        <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps</span> <span class="o">+=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irrep</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># t=1, p=1</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">K_irreps</span> <span class="o">+=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irrep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># t=1, p=1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># 对于非 SOC，J 是一个标量 (L=0)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps</span> <span class="o">+=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irrep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># t=1, p=1</span>
            
            <span class="k">for</span> <span class="n">irs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps_dim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">irs</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">irs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">K_irreps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">K_irreps_dim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">irs</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>   
            
            <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps_dim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">J_irreps_dim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">K_irreps_dim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K_irreps_dim</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_basis_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        根据哈密顿量类型 (`ham_type`) 和最大原子轨道数 (`nao_max`) 设置基组信息。</span>
<span class="sd">        这会调用特定于 `openmx`, `siesta`, `abacus` 等的方法。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="o">==</span> <span class="s1">&#39;openmx&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_openmx_basis</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="o">==</span> <span class="s1">&#39;siesta&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_siesta_basis</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="o">==</span> <span class="s1">&#39;abacus&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_abacus_basis</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="o">==</span> <span class="s1">&#39;pasp&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x1o&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;不支持的哈密顿量类型: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span><span class="si">}</span><span class="s2">&#39;。&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_openmx_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        为 &#39;openmx&#39; 类型的哈密顿量设置基组信息。</span>
<span class="sd">        定义了每种元素的价电子数、轨道构成 (Irreps)，以及轨道在矩阵中的索引重排方式。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span> <span class="o">=</span> <span class="p">{</span><span class="n">Element</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;He&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Li&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Be&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;O&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ne&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Na&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Al&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Si&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ti&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Fe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Co&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ni&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Zn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ga&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;As&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Se&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Br&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Kr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Rb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Zr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Nb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Tc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ru&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Rh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;In&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Te&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Xe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ba&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;La&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ce&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Nd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ho&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Lu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Hf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Re&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Os&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Au&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Hg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Tl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Bi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span>
                        <span class="p">}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">14</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x0e+1x1o+1x1o+1x2e&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">{</span>  <span class="mi">1</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="c1"># H</span>
                                <span class="mi">2</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="c1"># He</span>
                                <span class="mi">3</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="c1"># Li</span>
                                <span class="mi">4</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="c1"># Be</span>
                                <span class="mi">5</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># B</span>
                                <span class="mi">6</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># C</span>
                                <span class="mi">7</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># N</span>
                                <span class="mi">8</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># O</span>
                                <span class="mi">9</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># F</span>
                                <span class="mi">10</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ne</span>
                                <span class="mi">11</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Na</span>
                                <span class="mi">12</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Mg</span>
                                <span class="mi">13</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Al</span>
                                <span class="mi">14</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Si</span>
                                <span class="mi">15</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># p</span>
                                <span class="mi">16</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># S</span>
                                <span class="mi">17</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Cl</span>
                                <span class="mi">18</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ar</span>
                                <span class="mi">19</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># K</span>
                                <span class="mi">20</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ca</span>
                                <span class="mi">35</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Br  </span>
                                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># V</span>
                                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Mn</span>
                            <span class="p">}</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">{</span>  <span class="mi">1</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="c1"># H</span>
                                <span class="mi">5</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="c1"># B</span>
                                <span class="mi">6</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="c1"># C</span>
                                <span class="mi">7</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="c1"># N</span>
                                <span class="mi">8</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">]</span> <span class="c1"># O</span>
                            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">9</span><span class="p">])</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x1o+1x1o+1x2e&quot;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">19</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">15</span><span class="p">])</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x0e+1x1o+1x1o+1x2e+1x2e&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">{</span>  <span class="mi">1</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="c1"># H</span>
                <span class="mi">2</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="c1"># He</span>
                <span class="mi">3</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="c1"># Li</span>
                <span class="mi">4</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="c1"># Be</span>
                <span class="mi">5</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># B</span>
                <span class="mi">6</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># C</span>
                <span class="mi">7</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># N</span>
                <span class="mi">8</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># O</span>
                <span class="mi">9</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># F</span>
                <span class="mi">10</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ne</span>
                <span class="mi">11</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Na</span>
                <span class="mi">12</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Mg</span>
                <span class="mi">13</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Al</span>
                <span class="mi">14</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Si</span>
                <span class="mi">15</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># p</span>
                <span class="mi">16</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># S</span>
                <span class="mi">17</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Cl</span>
                <span class="mi">18</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ar</span>
                <span class="mi">19</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># K</span>
                <span class="mi">20</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ca</span>
                <span class="mi">25</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Mn</span>
                <span class="mi">42</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Mo  </span>
                <span class="mi">83</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Bi  </span>
                <span class="mi">34</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Se </span>
                <span class="mi">24</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Cr </span>
                <span class="mi">53</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># I</span>
                <span class="mi">28</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ni</span>
                <span class="mi">35</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Br </span>
                <span class="mi">26</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Fe</span>
                <span class="mi">77</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Ir</span>
                <span class="mi">52</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Te</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># V</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Sb</span>
            <span class="p">}</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">26</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">19</span><span class="p">])</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x0e+1x1o+1x1o+1x2e+1x2e+1x3o&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">s3</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">p1</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span><span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span><span class="n">d1</span><span class="o">=</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span><span class="n">d2</span><span class="o">=</span><span class="p">[</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span><span class="n">f1</span><span class="o">=</span><span class="p">[</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">25</span><span class="p">]:</span> <span class="p">{</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span>  <span class="c1"># H6.0-s2p1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;He&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span>  <span class="c1"># He8.0-s2p1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Li&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="p">,</span>  <span class="c1"># Li8.0-s3p2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Be&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="p">,</span>  <span class="c1"># Be7.0-s2p2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># B7.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># C6.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># N6.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;O&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># O6.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># F6.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ne&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Ne9.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Na&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Na9.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Mg9.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Al&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Al7.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Si&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Si7.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># P7.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># S7.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Cl7.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Ar9.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># K10.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Ca9.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Sc9.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ti&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Ti7.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># V6.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Cr6.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Mn6.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Fe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Fe5.5H-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Co&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Co6.0H-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ni&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Ni6.0H-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Cu6.0H-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Zn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Zn6.0H-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ga&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Ga7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Ge7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;As&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># As7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Se&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Se7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Br&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Br7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Kr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Kr10.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Rb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Rb11.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Sr10.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Y10.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Zr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Zr7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Nb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Nb7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Mo7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Tc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Tc7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ru&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Ru7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Rh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Rh7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Pd7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Ag7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Cd7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;In&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># In7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Sn7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Sb7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Te&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Te7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># I7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Xe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Xe11.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Cs12.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ba&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Ba10.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;La&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># La8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ce&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Ce8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Pr8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Nd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Nd8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Pm8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Sm8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Dy8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ho&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Ho8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Lu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Lu8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Hf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Hf9.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Ta7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># W7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Re&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Re7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Os&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Os7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Ir7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Pt7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Au&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Au7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Hg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Hg8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Tl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Tl8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Pb8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Bi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Bi8.0-s3p2d2f1 </span>
            <span class="p">})()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;不支持的 NAO max &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="si">}</span><span class="s2">&#39; for &#39;openmx&#39;.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_siesta_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        为 &#39;siesta&#39; 类型的哈密顿量设置基组信息。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="mi">9</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
            <span class="mi">11</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">13</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">14</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">15</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="mi">16</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="mi">17</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span><span class="mi">18</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
            <span class="mi">19</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">22</span><span class="p">:</span><span class="mi">12</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="kc">None</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x1o+1x1o+1x2e&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">])</span> <span class="c1"># this list should follow the order in siesta. See spher_harm.f</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p1</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span><span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span><span class="n">d1</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">]:</span> <span class="p">{</span>
                <span class="mi">1</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># H</span>
                <span class="mi">2</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># He</span>
                <span class="mi">3</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Li</span>
                <span class="mi">4</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Be</span>
                <span class="mi">5</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># B</span>
                <span class="mi">6</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># C</span>
                <span class="mi">7</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># N</span>
                <span class="mi">8</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># O</span>
                <span class="mi">9</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># F</span>
                <span class="mi">10</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ne</span>
                <span class="mi">11</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Na</span>
                <span class="mi">12</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Mg</span>
                <span class="mi">13</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Al</span>
                <span class="mi">14</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Si</span>
                <span class="mi">15</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># P</span>
                <span class="mi">16</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># S</span>
                <span class="mi">17</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Cl</span>
                <span class="mi">18</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ar</span>
                <span class="mi">19</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># K</span>
                <span class="mi">20</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Cl</span>
            <span class="p">})()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">19</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x0e+1x1o+1x1o+1x2e+1x2e&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">17</span><span class="p">])</span> <span class="c1"># this list should follow the order in siesta. See spher_harm.f</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">s3</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">p1</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span><span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span><span class="n">d1</span><span class="o">=</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span><span class="n">d2</span><span class="o">=</span><span class="p">[</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">]:</span> <span class="p">{</span>
                <span class="mi">1</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># H</span>
                <span class="mi">2</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># He</span>
                <span class="mi">3</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Li</span>
                <span class="mi">4</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Be</span>
                <span class="mi">5</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># B</span>
                <span class="mi">6</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># C</span>
                <span class="mi">7</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># N</span>
                <span class="mi">8</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># O</span>
                <span class="mi">9</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># F</span>
                <span class="mi">10</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ne</span>
                <span class="mi">11</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Na</span>
                <span class="mi">12</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Mg</span>
                <span class="mi">13</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Al</span>
                <span class="mi">14</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Si</span>
                <span class="mi">15</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># P</span>
                <span class="mi">16</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># S</span>
                <span class="mi">17</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Cl</span>
                <span class="mi">18</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ar</span>
                <span class="mi">19</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># K</span>
                <span class="mi">20</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Cl</span>
                <span class="mi">22</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span> <span class="c1"># Ti, created by Qin.</span>
            <span class="p">})()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;不支持的 NAO max &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="si">}</span><span class="s2">&#39; for &#39;siesta&#39;.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_abacus_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        为 &#39;abacus&#39; 类型的哈密顿量设置基组信息。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="mi">3</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                        <span class="mi">5</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">6</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                        <span class="mi">7</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">8</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                        <span class="mi">9</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>  <span class="mi">10</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                        <span class="mi">11</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="mi">13</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                        <span class="mi">15</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">16</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                        <span class="mi">17</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>  <span class="mi">18</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                        <span class="mi">19</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>  <span class="mi">20</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="mi">21</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                        <span class="mi">23</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">24</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                        <span class="mi">25</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">26</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                        <span class="mi">27</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">28</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
                        <span class="mi">29</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">30</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                        <span class="mi">31</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">32</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                        <span class="mi">33</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">34</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                        <span class="mi">35</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>  <span class="mi">36</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                        <span class="mi">37</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>  <span class="mi">38</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="mi">39</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">40</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                        <span class="mi">41</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">42</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                        <span class="mi">43</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">44</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                        <span class="mi">45</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">46</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
                        <span class="mi">47</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">48</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                        <span class="mi">49</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">50</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                        <span class="mi">51</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">52</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                        <span class="mi">53</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">54</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
                        <span class="mi">55</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">56</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="mi">57</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">72</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span>
                        <span class="mi">73</span><span class="p">:</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">74</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
                        <span class="mi">75</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">76</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                        <span class="mi">77</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">78</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
                        <span class="mi">79</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">80</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                        <span class="mi">81</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">82</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                        <span class="mi">83</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x1o+1x1o+1x2e&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p1</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span><span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span><span class="n">d1</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">]:</span> <span class="p">{</span>
                <span class="mi">1</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># H</span>
                <span class="mi">2</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># He</span>
                <span class="mi">5</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># B</span>
                <span class="mi">6</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># C</span>
                <span class="mi">7</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># N</span>
                <span class="mi">8</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># O</span>
                <span class="mi">9</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># F</span>
                <span class="mi">10</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># Ne</span>
                <span class="mi">14</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># Si</span>
                <span class="mi">15</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># P</span>
                <span class="mi">16</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># S</span>
                <span class="mi">17</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># Cl</span>
                <span class="mi">18</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># Ar</span>
            <span class="p">})()</span>           
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">27</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">20</span><span class="p">])</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x0e+1x0e+1x1o+1x1o+1x2e+1x2e+1x3o&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">26</span><span class="p">])</span> <span class="c1"># this list should follow the order in abacus.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">s3</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">s4</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">p1</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span><span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">],</span><span class="n">d1</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">],</span><span class="n">d2</span><span class="o">=</span><span class="p">[</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">],</span><span class="n">f1</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">26</span><span class="p">]:</span> <span class="p">{</span>
            <span class="mi">1</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># H</span>
            <span class="mi">2</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># He</span>
            <span class="mi">3</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Li</span>
            <span class="mi">4</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Bi</span>
            <span class="mi">5</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># B</span>
            <span class="mi">6</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># C</span>
            <span class="mi">7</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># N</span>
            <span class="mi">8</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># O</span>
            <span class="mi">9</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># F</span>
            <span class="mi">10</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ne</span>
            <span class="mi">11</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Na</span>
            <span class="mi">12</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Mg</span>
            <span class="c1"># 13: Al</span>
            <span class="mi">14</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Si</span>
            <span class="mi">15</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># P</span>
            <span class="mi">16</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># S</span>
            <span class="mi">17</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Cl</span>
            <span class="mi">18</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ar</span>
            <span class="mi">19</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># K</span>
            <span class="mi">20</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ca</span>
            <span class="mi">21</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Sc</span>
            <span class="mi">22</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ti</span>
            <span class="mi">23</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># V</span>
            <span class="mi">24</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Cr</span>
            <span class="mi">25</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Mn</span>
            <span class="mi">26</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Fe</span>
            <span class="mi">27</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Co</span>
            <span class="mi">28</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ni</span>
            <span class="mi">29</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Cu</span>
            <span class="mi">30</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Zn</span>
            <span class="mi">31</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ga</span>
            <span class="mi">32</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ge</span>
            <span class="mi">33</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># As</span>
            <span class="mi">34</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Se</span>
            <span class="mi">35</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Br</span>
            <span class="mi">36</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Kr</span>
            <span class="mi">37</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Rb</span>
            <span class="mi">38</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Sr</span>
            <span class="mi">39</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Y</span>
            <span class="mi">40</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Zr</span>
            <span class="mi">41</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Nb</span>
            <span class="mi">42</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Mo</span>
            <span class="mi">43</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Tc</span>
            <span class="mi">44</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ru</span>
            <span class="mi">45</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Rh</span>
            <span class="mi">46</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Pd</span>
            <span class="mi">47</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ag</span>
            <span class="mi">48</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Cd</span>
            <span class="mi">49</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># In</span>
            <span class="mi">50</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Sn</span>
            <span class="mi">51</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Sb</span>
            <span class="mi">52</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Te</span>
            <span class="mi">53</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># I</span>
            <span class="mi">54</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Xe</span>
            <span class="mi">55</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Cs</span>
            <span class="mi">56</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ba</span>
            <span class="c1">#</span>
            <span class="mi">79</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Au</span>
            <span class="mi">80</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Hg</span>
            <span class="mi">81</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Tl</span>
            <span class="mi">82</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Pb</span>
            <span class="mi">83</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Bi</span>
        <span class="p">})()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">33</span><span class="p">])</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x0e+1x0e+1x1o+1x1o+1x1o+1x1o+1x2e+1x2e+1x3o+1x3o&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">39</span><span class="p">])</span> <span class="c1"># this list should follow the order in abacus.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                   <span class="n">s2</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                   <span class="n">s3</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                   <span class="n">s4</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                   <span class="n">p1</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>
                   <span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">],</span>
                   <span class="n">p3</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span>
                   <span class="n">p4</span><span class="o">=</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">],</span>
                   <span class="n">d1</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">],</span>
                   <span class="n">d2</span><span class="o">=</span><span class="p">[</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">25</span><span class="p">],</span>
                   <span class="n">f1</span><span class="o">=</span><span class="p">[</span><span class="mi">26</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">32</span><span class="p">],</span>
                   <span class="n">f2</span><span class="o">=</span><span class="p">[</span><span class="mi">33</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">39</span><span class="p">]:</span> <span class="p">{</span>
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ag&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Al&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">p3</span><span class="o">+</span><span class="n">p4</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ar&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;As&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Au&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ba&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Be&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Bi&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Br&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ca&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Cd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Cl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Co&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Cr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Cs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Cu&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Fe&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ga&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ge&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;He&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Hf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="o">+</span><span class="n">f2</span><span class="p">,</span>  <span class="c1"># Hf_gga_10au_100Ry_4s2p2d2f.orb</span>
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Hg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;In&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Kr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Li&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Mg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Mn&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Mo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Na&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Nb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ne&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ni&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Pb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Pd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Pt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Re&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Rh&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ru&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Sb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Sc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Se&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Si&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Sn&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Sr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ta&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="o">+</span><span class="n">f2</span><span class="p">,</span>  <span class="c1"># Ta_gga_10au_100Ry_4s2p2d2f.orb</span>
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Tc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Te&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ti&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Tl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="o">+</span><span class="n">f2</span><span class="p">,</span>  <span class="c1"># W_gga_10au_100Ry_4s2p2d2f.orb</span>
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Xe&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Zn&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Zr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>
                <span class="p">})()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;不支持的 NAO max &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="si">}</span><span class="s2">&#39; for &#39;abacus&#39;.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_band_num_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band_num_control</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;设置计算能带时每个原子类型贡献的能带数量。&quot;&quot;&quot;</span>
        <span class="c1"># 能带数量控制</span>
        <span class="k">if</span> <span class="n">band_num_control</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_reciprocal_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># 为保持一致性，将原子序数转换为整数</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">band_num_control</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="o">=</span> <span class="n">band_num_control</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_ham_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">irreps_in</span><span class="p">,</span> <span class="n">irreps_out</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        创建一个 `HamLayer` 实例。</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            irreps_in (o3.Irreps): 输入的不可约表示。</span>
<span class="sd">            irreps_out (o3.Irreps): 输出的不可约表示。</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            HamLayer: 一个配置好的 HamLayer 实例。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HamLayer</span><span class="p">(</span>
            <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in</span><span class="p">,</span>
            <span class="n">feature_irreps_hidden</span><span class="o">=</span><span class="n">irreps_in</span><span class="p">,</span>
            <span class="n">irreps_out</span><span class="o">=</span><span class="n">irreps_out</span><span class="p">,</span>
            <span class="n">nonlinearity_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonlinearity_type</span><span class="p">,</span>
            <span class="n">resnet</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

<div class="viewcode-block" id="HamGNNPlusPlusOut.matrix_merge">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.matrix_merge">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">matrix_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sph_split</span><span class="p">):</span>   
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        将一系列球谐系数（等变特征）通过 Clebsch-Gordan 积合并成矩阵块。</span>

<span class="sd">        这是模型的核心步骤之一，它将神经网络预测的抽象特征（`sph_split`）</span>
<span class="sd">        转换为物理上可解释的哈密顿量或重叠矩阵的组成部分。</span>

<span class="sd">        Args:</span>
<span class="sd">            sph_split (list of torch.Tensor): </span>
<span class="sd">                一个张量列表，每个张量对应 `self.ham_irreps` 中的一个不可约表示的系数。</span>
<span class="sd">                形状为 `(N_batch, 2L+1)`。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: </span>
<span class="sd">                合并后的矩阵块，形状为 `(N_batch, nao_max * nao_max)`。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sph_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sph_split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 用于访问正确 irreps 的索引</span>
        <span class="n">start_i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="n">n_i</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">start_j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                <span class="n">n_j</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="o">-</span><span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="p">),</span> <span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># 计算逆球谐张量积</span>
                    <span class="n">cg</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cg_cal</span><span class="p">(</span><span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">product</span> <span class="o">=</span> <span class="p">(</span><span class="n">cg</span><span class="o">*</span><span class="n">sph_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># 将乘积添加到块的适当部分</span>
                    <span class="n">blockpart</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">start_i</span><span class="p">,</span><span class="n">n_i</span><span class="p">)</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">start_j</span><span class="p">,</span><span class="n">n_j</span><span class="p">)</span>
                    <span class="n">blockpart</span> <span class="o">+=</span> <span class="n">product</span>

                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">start_j</span> <span class="o">+=</span> <span class="n">n_j</span>
            <span class="n">start_i</span> <span class="o">+=</span> <span class="n">n_i</span>
            
        <span class="k">return</span> <span class="n">block</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.matrix_2rank_merge">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.matrix_2rank_merge">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">matrix_2rank_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sph_split</span><span class="p">):</span>   
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        将球谐系数合并为二阶张量（3x3矩阵），用于 SOC 计算中的交换项 J。</span>

<span class="sd">        Args:</span>
<span class="sd">            sph_split (list of torch.Tensor): </span>
<span class="sd">                对应 `self.J_irreps` 的球谐系数列表。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: </span>
<span class="sd">                形状为 `(N_batch, N_blocks, 3, 3)` 的张量。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sph_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nblocks</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sph_split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># 形状: (N_batch, N_blocks, 3, 3)</span>
        <span class="n">indices_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 用于访问正确 irreps 的索引</span>
        <span class="n">block_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="c1"># 计算逆球谐张量积</span>
                    <span class="n">cg</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cg_cal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">product</span> <span class="o">=</span> <span class="p">(</span><span class="n">cg</span><span class="o">*</span><span class="n">sph_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 形状: (N_batch, 3, 3)</span>

                    <span class="c1"># 将乘积添加到块的适当部分</span>
                    <span class="n">block</span><span class="p">[:,</span><span class="n">block_idx</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">block</span><span class="p">[:,</span><span class="n">block_idx</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">product</span>

                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">block_idx</span> <span class="o">+=</span> <span class="mi">1</span>
    
        <span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">indices_change</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">indices_change</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]]</span>
        <span class="k">return</span> <span class="n">block</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.matrix_0rank_merge">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.matrix_0rank_merge">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">matrix_0rank_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sph_split</span><span class="p">):</span>   
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        将零阶（标量）球谐系数合并为矩阵。</span>

<span class="sd">        这用于非 SOC 情况下的交换项 J，其中 J 是一个标量。</span>

<span class="sd">        Args:</span>
<span class="sd">            sph_split (list of torch.Tensor): </span>
<span class="sd">                对应零阶 Irreps 的系数列表。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: </span>
<span class="sd">                形状为 `(N_batch, nao_max, nao_max)` 的矩阵。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sph_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sph_split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># 形状: (N_batch, nao_max, nao_max)</span>
        
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 用于访问正确 irreps 的索引</span>
        <span class="n">start_i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="n">n_i</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">start_j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                <span class="n">n_j</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">product</span> <span class="o">=</span> <span class="n">sph_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_i</span><span class="p">,</span> <span class="n">n_j</span><span class="p">)</span> <span class="c1"># 形状: (N_batch, n_i, n_j)</span>
                <span class="c1"># 将乘积添加到块的适当部分</span>
                <span class="n">blockpart</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">start_i</span><span class="p">,</span><span class="n">n_i</span><span class="p">)</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">start_j</span><span class="p">,</span><span class="n">n_j</span><span class="p">)</span>
                <span class="n">blockpart</span> <span class="o">+=</span> <span class="n">product</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">start_j</span> <span class="o">+=</span> <span class="n">n_j</span>
            <span class="n">start_i</span> <span class="o">+=</span> <span class="n">n_i</span>
        <span class="k">return</span> <span class="n">block</span> <span class="c1"># 形状: (N_batch, nao_max, nao_max)</span></div>

    
<div class="viewcode-block" id="HamGNNPlusPlusOut.J_merge">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.J_merge">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">J_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lagrange</span><span class="p">):</span>   
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        将拉格朗日乘子（交换场）合并成完整的交换相互作用矩阵 J。</span>

<span class="sd">        Args:</span>
<span class="sd">            lagrange (torch.Tensor): 神经网络预测的交换场系数。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: </span>
<span class="sd">                交换相互作用矩阵 J。</span>
<span class="sd">                如果 `soc_switch` 为 True, 形状为 `(N_batch, nao_max, nao_max, 3, 3)`。</span>
<span class="sd">                否则，形状为 `(N_batch, nao_max, nao_max)`。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span><span class="p">:</span>
            <span class="n">sph_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">lagrange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps_dim</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">lagrange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_2rank_merge</span><span class="p">(</span><span class="n">sph_split</span><span class="p">)</span>  <span class="c1"># 形状: (N_batch, N_blocks, 3, 3)</span>

            <span class="n">block</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lagrange</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">lagrange</span><span class="p">)</span>

            <span class="n">block_idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 用于访问正确块的索引</span>
            <span class="n">start_i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
                <span class="n">n_i</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">start_j</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                    <span class="n">n_j</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">block</span><span class="p">[:,</span> <span class="n">start_i</span><span class="p">:</span><span class="n">start_i</span><span class="o">+</span><span class="n">n_i</span><span class="p">,</span> <span class="n">start_j</span><span class="p">:</span><span class="n">start_j</span><span class="o">+</span><span class="n">n_j</span><span class="p">]</span> <span class="o">=</span> <span class="n">lagrange</span><span class="p">[:,</span><span class="n">block_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">lagrange</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_i</span><span class="p">,</span> <span class="n">n_j</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="n">block_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">start_j</span> <span class="o">+=</span> <span class="n">n_j</span>
                <span class="n">start_i</span> <span class="o">+=</span> <span class="n">n_i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sph_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">lagrange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps_dim</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_0rank_merge</span><span class="p">(</span><span class="n">sph_split</span><span class="p">)</span>  <span class="c1"># 形状: (N_batch, nao_max, nao_max)</span>
            
        <span class="k">return</span> <span class="n">block</span> <span class="c1"># 形状: (N_batch, nao_max, nao_max, 3, 3)</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.K_merge">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.K_merge">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">K_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lagrange</span><span class="p">):</span>   
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        将拉格朗日乘子合并成四阶相互作用矩阵 K。</span>

<span class="sd">        Args:</span>
<span class="sd">            lagrange (torch.Tensor): 神经网络预测的四阶项系数。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: 四阶相互作用矩阵 K，形状 `(N_batch, nao_max, nao_max)`。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">lagrange</span> <span class="o">=</span> <span class="n">lagrange</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">lagrange</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 形状: (N_atoms/N_edges, N_blocks)</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lagrange</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">lagrange</span><span class="p">)</span>
        
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 用于访问正确 irreps 的索引</span>
        <span class="n">start_i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="n">n_i</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">start_j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                <span class="n">n_j</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">block</span><span class="p">[:,</span> <span class="n">start_i</span><span class="p">:</span><span class="n">start_i</span><span class="o">+</span><span class="n">n_i</span><span class="p">,</span> <span class="n">start_j</span><span class="p">:</span><span class="n">start_j</span><span class="o">+</span><span class="n">n_j</span><span class="p">]</span> <span class="o">=</span> <span class="n">lagrange</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">lagrange</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_i</span><span class="p">,</span> <span class="n">n_j</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">start_j</span> <span class="o">+=</span> <span class="n">n_j</span>
            <span class="n">start_i</span> <span class="o">+=</span> <span class="n">n_i</span>
            
        <span class="k">return</span> <span class="n">block</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.change_index">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.change_index">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hamiltonian</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        根据 DFT 软件（如 openmx, siesta）的约定，调整输出矩阵元素的顺序。</span>
<span class="sd">        这确保了生成的哈密顿量与目标软件的原子轨道顺序相匹配。</span>

<span class="sd">        Args:</span>
<span class="sd">            hamiltonian (torch.Tensor): 原始哈密顿量矩阵。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: 索引调整后的哈密顿量。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;minus_index&#39;</span><span class="p">):</span>
            <span class="n">hamiltonian</span> <span class="o">=</span> <span class="n">hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>   
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hamiltonian</span> <span class="o">=</span> <span class="n">hamiltonian</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]]</span> 
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;minus_index&#39;</span><span class="p">):</span>
                <span class="c1"># 对某些 m!=0 的轨道乘以 -1，以匹配 siesta 等软件的 Condon-Shortley 相位约定</span>
                <span class="n">hamiltonian</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span><span class="p">,:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">hamiltonian</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span><span class="p">,:]</span>
                <span class="n">hamiltonian</span><span class="p">[:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">hamiltonian</span><span class="p">[:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span><span class="p">]</span>
            <span class="n">hamiltonian</span> <span class="o">=</span> <span class="n">hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>                
        <span class="k">return</span> <span class="n">hamiltonian</span></div>

    
<div class="viewcode-block" id="HamGNNPlusPlusOut.convert_to_mole_Ham">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.convert_to_mole_Ham">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_to_mole_Ham</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        将 onsite 和 offsite 矩阵块组装成完整的分子哈密顿量。</span>
<span class="sd">        这个函数目前似乎没有被使用。</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Data): 输入的图数据。</span>
<span class="sd">            Hon (torch.Tensor): Onsite 哈密顿量块。</span>
<span class="sd">            Hoff (torch.Tensor): Offsite 哈密顿量块。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: 组装后的完整哈密顿量。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 获取每个晶胞中的原子数</span>
        <span class="n">max_atoms</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                
        <span class="c1"># 解析原子轨道基组定义</span>
        <span class="n">basis_definition</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">basis_def_temp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">)</span>
        <span class="c1"># key 是原子序数, value 是占据的轨道</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">basis_def_temp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">basis_definition</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">basis_def_temp</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_atoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="c1"># 形状: [N_batch, max_atoms*nao_max]  </span>
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">orb_mask</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">orb_mask</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:]</span>       <span class="c1"># 形状: [N_batch, max_atoms*nao_max, max_atoms*nao_max]</span>
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">orb_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_atoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="c1"># 形状: [N_atoms*nao_max, max_atoms*nao_max]</span>
        
        <span class="n">atom_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span> <span class="c1"># 形状: [N_atoms, max_atoms, nao_max**2]</span>
        <span class="n">H</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">,</span> <span class="n">atom_idx</span><span class="o">%</span><span class="n">max_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hon</span>
        <span class="n">H</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">%</span><span class="n">max_atoms</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hoff</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="c1"># 形状: [N_atoms, max_atoms, nao_max, nao_max]</span>

        <span class="c1"># 重塑哈密顿量的维度</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">max_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

        <span class="c1"># 掩码填充的轨道</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">orb_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">orbs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">max_atoms</span><span class="p">)))</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">orbs</span><span class="p">)</span>              
        <span class="k">return</span> <span class="n">H</span></div>

    
<div class="viewcode-block" id="HamGNNPlusPlusOut.cat_onsite_and_offsite">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.cat_onsite_and_offsite">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cat_onsite_and_offsite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        将批处理中的 onsite 和 offsite 矩阵块按顺序拼接起来。</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Data): 输入的图数据。</span>
<span class="sd">            Hon (torch.Tensor): Onsite 矩阵块。</span>
<span class="sd">            Hoff (torch.Tensor): Offsite 矩阵块。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: 拼接后的矩阵块。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 获取每个晶胞中的节点数</span>
        <span class="n">node_counts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span>
        <span class="n">Hon_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Hon</span><span class="p">,</span> <span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">edge_num</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">edge_num</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">edge_num</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Hoff_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Hoff</span><span class="p">,</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">H</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_counts</span><span class="p">)):</span>
            <span class="n">H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Hon_split</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Hoff_split</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">H</span> </div>

    
<div class="viewcode-block" id="HamGNNPlusPlusOut.symmetrize_Hon">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.symmetrize_Hon">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">symmetrize_Hon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Hon</span><span class="p">,</span> <span class="n">sign</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        对称化 Onsite 矩阵块。</span>

<span class="sd">        Args:</span>
<span class="sd">            Hon (torch.Tensor): Onsite 矩阵块。</span>
<span class="sd">            sign (str): 对称化方式，&#39;+&#39; 表示 (A + A.T)/2 (厄米)，&#39;-&#39; 表示 (A - A.T)/2 (反厄米)。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: 对称化后的矩阵。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">:</span>
            <span class="n">Hon</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">Hon</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Hon</span> <span class="o">+</span> <span class="n">Hon</span><span class="o">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Hon</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Hon</span> <span class="o">-</span> <span class="n">Hon</span><span class="o">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">Hon</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Hon</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Hon</span></div>

    
<div class="viewcode-block" id="HamGNNPlusPlusOut.symmetrize_Hoff">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.symmetrize_Hoff">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">symmetrize_Hoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">,</span> <span class="n">inv_edge_idx</span><span class="p">,</span> <span class="n">sign</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        对称化 Offsite 矩阵块。</span>
<span class="sd">        利用 `inv_edge_idx` (逆向边的索引) 来确保 H_ij = H_ji.T。</span>

<span class="sd">        Args:</span>
<span class="sd">            Hoff (torch.Tensor): Offsite 矩阵块。</span>
<span class="sd">            inv_edge_idx (torch.Tensor): 逆向边的索引。</span>
<span class="sd">            sign (str): 对称化方式，&#39;+&#39; 或 &#39;-&#39;。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: 对称化后的矩阵。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">:</span>
            <span class="n">Hoff</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">Hoff</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Hoff</span> <span class="o">+</span> <span class="n">Hoff</span><span class="p">[</span><span class="n">inv_edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Hoff</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Hoff</span> <span class="o">-</span> <span class="n">Hoff</span><span class="p">[</span><span class="n">inv_edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">Hoff</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Hoff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Hoff</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.symmetrize_Hon_soc">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.symmetrize_Hon_soc">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">symmetrize_Hon_soc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Hon</span><span class="p">,</span> <span class="n">sign</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;对称化包含 SOC 的 Onsite 矩阵块 (尺寸为 2*nao_max)。&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">:</span>
            <span class="n">Hon</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">Hon</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Hon</span> <span class="o">+</span> <span class="n">Hon</span><span class="o">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Hon</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Hon</span> <span class="o">-</span> <span class="n">Hon</span><span class="o">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">Hon</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Hon</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Hon</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Hon</span>    </div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.symmetrize_Hoff_soc">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.symmetrize_Hoff_soc">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">symmetrize_Hoff_soc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">,</span> <span class="n">inv_edge_idx</span><span class="p">,</span> <span class="n">sign</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;对称化包含 SOC 的 Offsite 矩阵块 (尺寸为 2*nao_max)。&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">:</span>
            <span class="n">Hoff</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">Hoff</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Hoff</span> <span class="o">+</span> <span class="n">Hoff</span><span class="p">[</span><span class="n">inv_edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Hoff</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Hoff</span> <span class="o">-</span> <span class="n">Hoff</span><span class="p">[</span><span class="n">inv_edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">Hoff</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Hoff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Hoff</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Hoff</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.cal_band_energy_debug">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.cal_band_energy_debug">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cal_band_energy_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">,</span> <span class="n">Son</span><span class="p">,</span> <span class="n">Soff</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">export_reciprocal_values</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        计算能带结构（调试版本）。</span>
<span class="sd">        </span>
<span class="sd">        通过傅里叶变换将实空间的哈密顿量 H(R) 和重叠矩阵 S(R) 转换为</span>
<span class="sd">        倒易空间的 H(k) 和 S(k)，然后求解广义本征值问题 `H(k)c = ES(k)c` 来得到能带。</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            Hon (torch.Tensor): 预测的 onsite 哈密顿量。</span>
<span class="sd">            Hoff (torch.Tensor): 预测的 offsite 哈密顿量。</span>
<span class="sd">            Son (torch.Tensor): 预测的 onsite 重叠矩阵。</span>
<span class="sd">            Soff (torch.Tensor): 预测的 offsite 重叠矩阵。</span>
<span class="sd">            data (Data): 输入数据。</span>
<span class="sd">            export_reciprocal_values (bool): 是否返回倒易空间矩阵。</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: 包含能带能量、波函数、带隙等信息的元组。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell</span> <span class="c1"># 形状:(N_batch, 3, 3)</span>
        <span class="n">Nbatch</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># 解析原子轨道基组定义</span>
        <span class="n">basis_definition</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="c1"># key 是原子序数, value 是占据轨道的索引。</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">basis_definition</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span> <span class="c1"># 形状: [N_atoms, nao_max] </span>
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">orb_mask</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状: [n_atoms, nao_max]</span>
        <span class="n">orb_mask_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nbatch</span><span class="p">):</span>
            <span class="n">orb_mask_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orb_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span> <span class="n">orb_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># 形状: [n_atoms*nao_max, n_atoms*nao_max]</span>
        
        <span class="c1"># 设置价电子数</span>
        <span class="n">num_val</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">num_val</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">num_val</span> <span class="o">=</span> <span class="n">num_val</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span> <span class="c1"># 形状: [N_atoms]</span>
        <span class="n">num_val</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">num_val</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状: [N_batch]</span>
                
        <span class="c1"># 初始化 band_num_win</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">band_num_win</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">band_num_win</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">band_num_win</span> <span class="o">=</span> <span class="n">band_num_win</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span> <span class="c1"># 形状: [N_atoms,]   </span>
            <span class="n">band_num_win</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">band_num_win</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状: (N_batch,)</span>
             
        <span class="c1"># 按 batch 分离 Hon 和 Hoff</span>
        <span class="n">node_counts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span>
        <span class="n">node_counts_shift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">node_counts</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">node_counts</span>
        <span class="n">Hon_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Hon</span><span class="p">,</span> <span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Son_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Son</span><span class="p">,</span> <span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Son_pred_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Son</span><span class="p">,</span> <span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">edge_num</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">edge_num</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">edge_num</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状: (N_batch,)</span>
        <span class="n">edge_num_shift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">edge_num</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">edge_num</span>
        <span class="n">Hoff_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Hoff</span><span class="p">,</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Soff_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Soff</span><span class="p">,</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Soff_pred_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Soff</span><span class="p">,</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
            <span class="n">dSon_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dSon</span><span class="p">,</span> <span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dSoff_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dSoff</span><span class="p">,</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">band_energy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">wavefunction</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">H_reciprocal</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">H_sym</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">S_reciprocal</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dS_reciprocal</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nbatch</span><span class="p">):</span>
            <span class="n">k_vec</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">k_vecs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>   
            <span class="n">natoms</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            
            <span class="c1"># 初始化 H(k) 和 S(k)       </span>
            <span class="c1"># 傅里叶变换的相位因子</span>
            <span class="n">coe</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">nbr_shift</span><span class="p">[</span><span class="n">edge_num_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edge_num</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="kc">None</span><span class="p">,:]</span><span class="o">*</span><span class="n">k_vec</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># (n_edges, 1, 3)*(1, num_k, 3) -&gt; (n_edges, num_k)     </span>
            
            <span class="n">HK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hon</span><span class="p">))</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hon</span><span class="p">))</span>  
            <span class="n">SK_pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hon</span><span class="p">))</span>           
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">dSK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hon</span><span class="p">))</span>

            <span class="n">na</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="c1"># 添加 onsite 部分 (R=0)</span>
            <span class="n">HK</span><span class="p">[:,</span><span class="n">na</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span> <span class="o">+=</span>  <span class="n">Hon_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">HK</span><span class="p">)</span> <span class="c1"># 形状 (num_k, n_atoms, nao_max, nao_max)</span>
            <span class="n">SK</span><span class="p">[:,</span><span class="n">na</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span> <span class="o">+=</span>  <span class="n">Son_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">SK</span><span class="p">)</span>
            <span class="n">SK_pred</span><span class="p">[:,</span><span class="n">na</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span> <span class="o">+=</span>  <span class="n">Son_pred_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">SK_pred</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">dSK</span><span class="p">[:,</span><span class="n">na</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:,:]</span> <span class="o">+=</span>  <span class="n">dSon_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:,:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">dSK</span><span class="p">)</span>

            <span class="c1"># 添加 offsite 部分 (R!=0)</span>
            <span class="k">for</span> <span class="n">iedge</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edge_num</span><span class="p">[</span><span class="n">idx</span><span class="p">]):</span>
                <span class="c1"># 形状 (num_k, nao_max, nao_max) += (num_k, 1, 1)*(1, nao_max, nao_max)</span>
                <span class="n">j_idx</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="n">edge_num_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="n">iedge</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_counts_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">i_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">edge_num_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="n">iedge</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_counts_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">HK</span><span class="p">[:,</span><span class="n">j_idx</span><span class="p">,</span><span class="n">i_idx</span><span class="p">,:,:]</span> <span class="o">+=</span> <span class="n">coe</span><span class="p">[</span><span class="n">iedge</span><span class="p">,:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">Hoff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">iedge</span><span class="p">,:,:]</span>
                <span class="n">SK</span><span class="p">[:,</span><span class="n">j_idx</span><span class="p">,</span><span class="n">i_idx</span><span class="p">,:,:]</span> <span class="o">+=</span> <span class="n">coe</span><span class="p">[</span><span class="n">iedge</span><span class="p">,:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">Soff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">iedge</span><span class="p">,:,:]</span>
                <span class="n">SK_pred</span><span class="p">[:,</span><span class="n">j_idx</span><span class="p">,</span><span class="n">i_idx</span><span class="p">,:,:]</span> <span class="o">+=</span> <span class="n">coe</span><span class="p">[</span><span class="n">iedge</span><span class="p">,:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">Soff_pred_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">iedge</span><span class="p">,:,:]</span>
            
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iedge</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edge_num</span><span class="p">[</span><span class="n">idx</span><span class="p">]):</span>
                    <span class="n">j_idx</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="n">edge_num_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="n">iedge</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_counts_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">i_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">edge_num_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="n">iedge</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_counts_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">dSK</span><span class="p">[:,</span><span class="n">j_idx</span><span class="p">,</span><span class="n">i_idx</span><span class="p">,:,:,:]</span> <span class="o">+=</span> <span class="n">coe</span><span class="p">[</span><span class="n">iedge</span><span class="p">,:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">dSoff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">iedge</span><span class="p">,:,:,:]</span>

            <span class="n">HK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">HK</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#(nk, n_atoms, nao_max, n_atoms, nao_max)</span>
            <span class="n">HK</span> <span class="o">=</span> <span class="n">HK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">SK</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#(nk, n_atoms, nao_max, n_atoms, nao_max)</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">SK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">SK_pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">SK_pred</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#(nk, n_atoms, nao_max, n_atoms, nao_max)</span>
            <span class="n">SK_pred</span> <span class="o">=</span> <span class="n">SK_pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">dSK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">dSK</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="c1">#(nk, n_atoms, nao_max, n_atoms, nao_max, 3)</span>
                <span class="n">dSK</span> <span class="o">=</span> <span class="n">dSK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            
            <span class="c1"># 掩码 H(k) 和 S(k)</span>
            <span class="n">HK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">HK</span><span class="p">,</span> <span class="n">orb_mask_batch</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">norbs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">HK</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">))</span>
            <span class="n">HK</span> <span class="o">=</span> <span class="n">HK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">norbs</span><span class="p">,</span> <span class="n">norbs</span><span class="p">)</span>
            
            <span class="n">SK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">SK</span><span class="p">,</span> <span class="n">orb_mask_batch</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">norbs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">SK</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">))</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">SK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">norbs</span><span class="p">,</span> <span class="n">norbs</span><span class="p">)</span>

            <span class="n">SK_pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">SK_pred</span><span class="p">,</span> <span class="n">orb_mask_batch</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">norbs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">SK_pred</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">))</span>
            <span class="n">SK_pred</span> <span class="o">=</span> <span class="n">SK_pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">norbs</span><span class="p">,</span> <span class="n">norbs</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">dSK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">dSK</span><span class="p">,</span> <span class="n">orb_mask_batch</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">dSK</span> <span class="o">=</span> <span class="n">dSK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">norbs</span><span class="p">,</span> <span class="n">norbs</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>            
            
            <span class="c1"># 计算能带能量</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">SK</span><span class="p">)</span>
            <span class="n">L_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">dim0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">L_inv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
            <span class="n">L_t_inv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">L_t</span><span class="p">)</span>
            <span class="c1"># 变换到正交基 H&#39; = L^-1 * H * (L^T)^-1</span>
            <span class="n">Hs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">HK</span><span class="p">),</span> <span class="n">L_t_inv</span><span class="p">)</span>
            <span class="n">orbital_energies</span><span class="p">,</span> <span class="n">orbital_coefficients</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">Hs</span><span class="p">)</span>        
            
            <span class="c1"># 将波函数系数转换回原始基</span>
            <span class="n">orbital_coefficients</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk, ika -&gt; iaj&#39;</span><span class="p">,</span> <span class="n">L_t_inv</span><span class="p">,</span> <span class="n">orbital_coefficients</span><span class="p">)</span>
            
            <span class="c1"># Numpy 实现（用于验证）</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            HK_t = HK.detach().cpu().numpy()</span>
<span class="sd">            SK_t = SK.detach().cpu().numpy()</span>
<span class="sd">            from scipy.linalg import eigh</span>
<span class="sd">            eigen = []</span>
<span class="sd">            eigen_vecs = []</span>
<span class="sd">            for ik in range(self.num_k):</span>
<span class="sd">                w, v = eigh(a=HK_t[ik], b=SK_t[ik])</span>
<span class="sd">                eigen.append(w)</span>
<span class="sd">                eigen_vecs.append(v)</span>
<span class="sd">            eigen_vecs = np.array(eigen_vecs) # (nk, nbands, nbands)</span>
<span class="sd">            eigen_vecs = np.swapaxes(eigen_vecs, -1, -2)</span>
<span class="sd">            </span>
<span class="sd">            lamda = np.einsum(&#39;nai, nij, naj -&gt; na&#39;, np.conj(eigen_vecs), SK_t, eigen_vecs).real</span>
<span class="sd">            lamda = 1/np.sqrt(lamda) # shape: (numk, norbs)</span>
<span class="sd">            eigen_vecs = eigen_vecs*lamda[:,:,None]  </span>
<span class="sd">            orbital_energies, orbital_coefficients = torch.Tensor(eigen).type_as(data.pos), torch.complex(torch.Tensor(eigen_vecs.real), torch.Tensor(eigen_vecs.imag)).type_as(HK)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="c1"># 归一化波函数</span>
                <span class="n">lamda</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nai, nij, naj -&gt; na&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">orbital_coefficients</span><span class="p">),</span> <span class="n">SK</span><span class="p">,</span> <span class="n">orbital_coefficients</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
                <span class="n">lamda</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lamda</span><span class="p">)</span> <span class="c1"># 形状: (numk, norbs)</span>
                <span class="n">orbital_coefficients</span> <span class="o">=</span> <span class="n">orbital_coefficients</span><span class="o">*</span><span class="n">lamda</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>    
                        
                <span class="n">H_reciprocal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HK</span><span class="p">)</span>
                <span class="n">S_reciprocal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SK_pred</span><span class="p">)</span>
                <span class="n">dS_reciprocal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dSK</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">orbital_energies</span> <span class="o">=</span> <span class="n">orbital_energies</span><span class="p">[:,:</span><span class="n">band_num_win</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span>
                <span class="n">orbital_coefficients</span> <span class="o">=</span> <span class="n">orbital_coefficients</span><span class="p">[:,:</span><span class="n">band_num_win</span><span class="p">[</span><span class="n">idx</span><span class="p">],:]</span>                
            <span class="n">band_energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">orbital_energies</span><span class="p">,</span> <span class="n">dim0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># [形状:(N_bands, num_k)]</span>
            <span class="n">wavefunction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orbital_coefficients</span><span class="p">)</span>  
            <span class="n">H_sym</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Hs</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> 
            <span class="n">numc</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">num_val</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">gap</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">orbital_energies</span><span class="p">[:,</span><span class="n">numc</span><span class="p">])</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">orbital_energies</span><span class="p">[:,</span><span class="n">numc</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>    
            
        <span class="n">band_energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">band_energy</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># [形状:(N_bands, num_k)]</span>
        
        <span class="n">gap</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
            <span class="n">wavefunction</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">wavefunction</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状:[N_batch, num_k, n_orbs, n_orbs]</span>
            <span class="n">HK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">H_reciprocal</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状:[N_batch, num_k, n_orbs, n_orbs]</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">S_reciprocal</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状:[N_batch, num_k, n_orbs, n_orbs]  </span>
            <span class="n">dSK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">dS_reciprocal</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状:[N_batch, num_k, n_orbs, n_orbs, 3]   </span>
            <span class="k">return</span> <span class="n">band_energy</span><span class="p">,</span> <span class="n">wavefunction</span><span class="p">,</span> <span class="n">HK</span><span class="p">,</span> <span class="n">SK</span><span class="p">,</span> <span class="n">dSK</span><span class="p">,</span> <span class="n">gap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wavefunction</span> <span class="o">=</span> <span class="p">[</span><span class="n">wavefunction</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nbatch</span><span class="p">)]</span>
            <span class="n">wavefunction</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">wavefunction</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状:[N_batch*num_k*n_orbs*n_orbs]</span>
            <span class="n">H_sym</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">H_sym</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状:(N_batch*num_k*n_orbs*n_orbs)</span>
            <span class="k">return</span> <span class="n">band_energy</span><span class="p">,</span> <span class="n">wavefunction</span><span class="p">,</span> <span class="n">gap</span><span class="p">,</span> <span class="n">H_sym</span>   </div>

    
<div class="viewcode-block" id="HamGNNPlusPlusOut.cal_band_energy">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.cal_band_energy">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cal_band_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Hon</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">export_reciprocal_values</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;计算能带结构（非调试的正式版本）。</span>

<span class="sd">        此函数通过给定的 onsite 和 offsite 矩阵块，为一批晶体构建 k 点依赖的哈密顿量</span>
<span class="sd">        和重叠矩阵，然后通过求解广义本征值问题来计算能带结构。</span>
<span class="sd">        该过程与 `cal_band_energy_debug` 类似，但流程更精简，不涉及对预计算 `Son`, `Soff` 的依赖。</span>
<span class="sd">        </span>
<span class="sd">        .. warning::</span>
<span class="sd">           当前实现主要针对 `openmx` 类型的哈密顿量。</span>

<span class="sd">        Args:</span>
<span class="sd">            Hon (torch.Tensor): 批处理中所有原子/轨道的 Onsite 矩阵块，形状通常为 `(N_nodes, nao_max*nao_max)`。</span>
<span class="sd">            Hoff (torch.Tensor): 批处理中所有边的 Offsite 矩阵块，形状通常为 `(N_edges, nao_max*nao_max)`。</span>
<span class="sd">            data (Data): PyG 图数据对象，包含原子结构、k点等信息。</span>
<span class="sd">            export_reciprocal_values (bool, optional): 如果为 True，则额外返回倒易空间中的</span>
<span class="sd">                哈密顿量 `HK`、重叠矩阵 `SK`、`SK`的导数`dSK` 和波函数。默认为 `False`。</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: </span>
<span class="sd">                如果 `export_reciprocal_values` 为 `False`，返回 `(band_energy, wavefunction, gap, H_sym)`。</span>
<span class="sd">                如果 `export_reciprocal_values` 为 `True`，返回 `(band_energy, wavefunction, HK, SK, dSK, gap)`。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell</span> <span class="c1"># 形状:(N_batch, 3, 3)</span>
        <span class="n">Nbatch</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># --- 步骤 1: 解析和准备掩码及参数 ---</span>
        <span class="c1"># 解析原子轨道基组定义，用于后续的掩码操作</span>
        <span class="n">basis_definition</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="c1"># key 是原子序数, value 是占据轨道的索引。</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">basis_definition</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span> <span class="c1"># 形状: [N_atoms, nao_max] </span>
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">orb_mask</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状: [n_atoms, nao_max]</span>
        <span class="n">orb_mask_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nbatch</span><span class="p">):</span>
            <span class="c1"># 为每个晶体创建轨道掩码，用于从 full-nao 矩阵中提取有效轨道</span>
            <span class="n">orb_mask_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orb_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span> <span class="n">orb_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># 形状: [n_atoms*nao_max, n_atoms*nao_max]</span>
        
        <span class="c1"># 设置每个晶体的价电子数</span>
        <span class="n">num_val</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">num_val</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">num_val</span> <span class="o">=</span> <span class="n">num_val</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span> <span class="c1"># 形状: [N_atoms]</span>
        <span class="n">num_val</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">num_val</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状: [N_batch]</span>
                
        <span class="c1"># 初始化能带窗口控制参数</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">band_num_win</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">band_num_win</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">band_num_win</span> <span class="o">=</span> <span class="n">band_num_win</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span> <span class="c1"># 形状: [N_atoms,]   </span>
            <span class="n">band_num_win</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">band_num_win</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状: (N_batch,)   </span>
             
        <span class="c1"># --- 步骤 2: 按批次分离输入张量 ---</span>
        <span class="n">node_counts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span>
        <span class="n">node_counts_shift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">node_counts</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">node_counts</span>
        <span class="n">Hon_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Hon</span><span class="p">,</span> <span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Son_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Son</span><span class="p">,</span> <span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">edge_num</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">edge_num</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">edge_num</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 形状: (N_batch,)</span>
        <span class="n">edge_num_shift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">edge_num</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">edge_num</span>
        <span class="n">Hoff_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Hoff</span><span class="p">,</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Soff_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Soff</span><span class="p">,</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
            <span class="n">dSon_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dSon</span><span class="p">,</span> <span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dSoff_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dSoff</span><span class="p">,</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">band_energy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">wavefunction</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">H_reciprocal</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">H_sym</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">S_reciprocal</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dS_reciprocal</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># --- 步骤 3: 遍历批处理中的每个晶体 ---</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nbatch</span><span class="p">):</span>
            <span class="n">k_vec</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">k_vecs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>   
            <span class="n">natoms</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            
            <span class="c1"># --- 3a: 构建 k 点依赖的矩阵 HK 和 SK ---</span>
            <span class="c1"># 计算傅里叶变换的相位因子</span>
            <span class="n">coe</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">nbr_shift</span><span class="p">[</span><span class="n">edge_num_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edge_num</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="kc">None</span><span class="p">,:]</span><span class="o">*</span><span class="n">k_vec</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># (nedges, 1, 3)*(1, num_k, 3) -&gt; (nedges, num_k)     </span>
            
            <span class="c1"># 初始化 k 点矩阵</span>
            <span class="n">HK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hon</span><span class="p">))</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hon</span><span class="p">))</span>            
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">dSK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hon</span><span class="p">))</span>

            <span class="c1"># 添加 On-site 部分 (k 点无关)</span>
            <span class="n">na</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">HK</span><span class="p">[:,</span><span class="n">na</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span> <span class="o">+=</span>  <span class="n">Hon_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">HK</span><span class="p">)</span> <span class="c1"># shape (num_k, natoms, nao_max, nao_max)</span>
            <span class="n">SK</span><span class="p">[:,</span><span class="n">na</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span> <span class="o">+=</span>  <span class="n">Son_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">SK</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">dSK</span><span class="p">[:,</span><span class="n">na</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:,:]</span> <span class="o">+=</span>  <span class="n">dSon_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:,:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">dSK</span><span class="p">)</span>

            <span class="c1"># 添加 Off-site 部分 (傅里叶变换)</span>
            <span class="k">for</span> <span class="n">iedge</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edge_num</span><span class="p">[</span><span class="n">idx</span><span class="p">]):</span>
                <span class="c1"># shape (num_k, nao_max, nao_max) += (num_k, 1, 1)*(1, nao_max, nao_max)</span>
                <span class="n">j_idx</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="n">edge_num_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="n">iedge</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_counts_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">i_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">edge_num_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="n">iedge</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_counts_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">HK</span><span class="p">[:,</span><span class="n">j_idx</span><span class="p">,</span><span class="n">i_idx</span><span class="p">,:,:]</span> <span class="o">+=</span> <span class="n">coe</span><span class="p">[</span><span class="n">iedge</span><span class="p">,:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">Hoff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">iedge</span><span class="p">,:,:]</span>
                <span class="n">SK</span><span class="p">[:,</span><span class="n">j_idx</span><span class="p">,</span><span class="n">i_idx</span><span class="p">,:,:]</span> <span class="o">+=</span> <span class="n">coe</span><span class="p">[</span><span class="n">iedge</span><span class="p">,:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">Soff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">iedge</span><span class="p">,:,:]</span>
            
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iedge</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edge_num</span><span class="p">[</span><span class="n">idx</span><span class="p">]):</span>
                    <span class="n">j_idx</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="n">edge_num_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="n">iedge</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_counts_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">i_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">edge_num_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="n">iedge</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_counts_shift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">dSK</span><span class="p">[:,</span><span class="n">j_idx</span><span class="p">,</span><span class="n">i_idx</span><span class="p">,:,:,:]</span> <span class="o">+=</span> <span class="n">coe</span><span class="p">[</span><span class="n">iedge</span><span class="p">,:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">dSoff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="n">iedge</span><span class="p">,:,:,:]</span>

            <span class="c1"># --- 3b: 重塑并掩码矩阵 ---</span>
            <span class="n">HK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">HK</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#(nk, natoms, nao_max, natoms, nao_max)</span>
            <span class="n">HK</span> <span class="o">=</span> <span class="n">HK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">SK</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#(nk, natoms, nao_max, natoms, nao_max)</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">SK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">dSK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">dSK</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="c1">#(nk, natoms, nao_max, natoms, nao_max, 3)</span>
                <span class="n">dSK</span> <span class="o">=</span> <span class="n">dSK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            
            <span class="c1"># 使用预先计算的轨道掩码，去除无效的轨道</span>
            <span class="n">HK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">HK</span><span class="p">,</span> <span class="n">orb_mask_batch</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">norbs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">HK</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">))</span>
            <span class="n">HK</span> <span class="o">=</span> <span class="n">HK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">norbs</span><span class="p">,</span> <span class="n">norbs</span><span class="p">)</span>
            
            <span class="n">SK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">SK</span><span class="p">,</span> <span class="n">orb_mask_batch</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">norbs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">SK</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">))</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">SK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">norbs</span><span class="p">,</span> <span class="n">norbs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">dSK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">dSK</span><span class="p">,</span> <span class="n">orb_mask_batch</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">dSK</span> <span class="o">=</span> <span class="n">dSK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">norbs</span><span class="p">,</span> <span class="n">norbs</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>            
            
            <span class="c1"># --- 3c: 求解广义本征值问题 ---</span>
            <span class="c1"># Calculate band energies</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">SK</span><span class="p">)</span>
            <span class="n">L_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">dim0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">L_inv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
            <span class="n">L_t_inv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">L_t</span><span class="p">)</span>
            <span class="n">Hs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">HK</span><span class="p">),</span> <span class="n">L_t_inv</span><span class="p">)</span>
            <span class="n">orbital_energies</span><span class="p">,</span> <span class="n">orbital_coefficients</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">Hs</span><span class="p">)</span>        
            
            <span class="c1"># Convert the wavefunction coefficients back to the original basis</span>
            <span class="n">orbital_coefficients</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk, ika -&gt; iaj&#39;</span><span class="p">,</span> <span class="n">L_t_inv</span><span class="p">,</span> <span class="n">orbital_coefficients</span><span class="p">)</span>
            
            <span class="c1"># Numpy implementation (for verification)</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            HK_t = HK.detach().cpu().numpy()</span>
<span class="sd">            SK_t = SK.detach().cpu().numpy()</span>
<span class="sd">            from scipy.linalg import eigh</span>
<span class="sd">            eigen = []</span>
<span class="sd">            eigen_vecs = []</span>
<span class="sd">            for ik in range(self.num_k):</span>
<span class="sd">                w, v = eigh(a=HK_t[ik], b=SK_t[ik])</span>
<span class="sd">                eigen.append(w)</span>
<span class="sd">                eigen_vecs.append(v)</span>
<span class="sd">            eigen_vecs = np.array(eigen_vecs) # (nk, nbands, nbands)</span>
<span class="sd">            eigen_vecs = np.swapaxes(eigen_vecs, -1, -2)</span>
<span class="sd">            </span>
<span class="sd">            lamda = np.einsum(&#39;nai, nij, naj -&gt; na&#39;, np.conj(eigen_vecs), SK_t, eigen_vecs).real</span>
<span class="sd">            lamda = 1/np.sqrt(lamda) # shape: (numk, norbs)</span>
<span class="sd">            eigen_vecs = eigen_vecs*lamda[:,:,None]  </span>
<span class="sd">            orbital_energies, orbital_coefficients = torch.Tensor(eigen).type_as(data.pos), torch.complex(torch.Tensor(eigen_vecs.real), torch.Tensor(eigen_vecs.imag)).type_as(HK)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            
            <span class="c1"># --- 3d: 后处理和存储结果 ---</span>
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="c1"># Normalize wave function</span>
                <span class="n">lamda</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nai, nij, naj -&gt; na&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">orbital_coefficients</span><span class="p">),</span> <span class="n">SK</span><span class="p">,</span> <span class="n">orbital_coefficients</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
                <span class="n">lamda</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lamda</span><span class="p">)</span> <span class="c1"># shape: (numk, norbs)</span>
                <span class="n">orbital_coefficients</span> <span class="o">=</span> <span class="n">orbital_coefficients</span><span class="o">*</span><span class="n">lamda</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>    
                        
                <span class="n">H_reciprocal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HK</span><span class="p">)</span>
                <span class="n">S_reciprocal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SK</span><span class="p">)</span>
                <span class="n">dS_reciprocal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dSK</span><span class="p">)</span>
            
            <span class="c1"># 计算带隙</span>
            <span class="n">numc</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">num_val</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">gap</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">orbital_energies</span><span class="p">[:,</span><span class="n">numc</span><span class="p">])</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">orbital_energies</span><span class="p">[:,</span><span class="n">numc</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            
            <span class="c1"># 根据配置控制输出的能带数量</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">orbital_energies</span> <span class="o">=</span> <span class="n">orbital_energies</span><span class="p">[:,:</span><span class="n">band_num_win</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span>   
                    <span class="n">orbital_coefficients</span> <span class="o">=</span> <span class="n">orbital_coefficients</span><span class="p">[:,:</span><span class="n">band_num_win</span><span class="p">[</span><span class="n">idx</span><span class="p">],:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="o">*</span><span class="n">numc</span><span class="p">)])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,</span> <span class="n">numc</span><span class="p">])</span>
                    <span class="n">orbital_energies</span> <span class="o">=</span> <span class="n">orbital_energies</span><span class="p">[:,</span><span class="n">numc</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">:</span><span class="n">numc</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">]</span>   
                    <span class="n">orbital_coefficients</span> <span class="o">=</span> <span class="n">orbital_coefficients</span><span class="p">[:,</span><span class="n">numc</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">:</span><span class="n">numc</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,:]</span>               
            <span class="n">band_energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">orbital_energies</span><span class="p">,</span> <span class="n">dim0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># [shape:(Nbands, num_k)]</span>
            <span class="n">wavefunction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orbital_coefficients</span><span class="p">)</span>  
            <span class="n">H_sym</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Hs</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>   
            
        <span class="c1"># --- 步骤 4: 整合批处理结果 ---</span>
        <span class="n">band_energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">band_energy</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># [shape:(Nbands, num_k)]</span>
        
        <span class="n">gap</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
            <span class="n">wavefunction</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">wavefunction</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># shape:[Nbatch, num_k, norbs, norbs]</span>
            <span class="n">HK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">H_reciprocal</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># shape:[Nbatch, num_k, norbs, norbs]</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">S_reciprocal</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># shape:[Nbatch, num_k, norbs, norbs]  </span>
            <span class="n">dSK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">dS_reciprocal</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># shape:[Nbatch, num_k, norbs, norbs, 3]   </span>
            <span class="k">return</span> <span class="n">band_energy</span><span class="p">,</span> <span class="n">wavefunction</span><span class="p">,</span> <span class="n">HK</span><span class="p">,</span> <span class="n">SK</span><span class="p">,</span> <span class="n">dSK</span><span class="p">,</span> <span class="n">gap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wavefunction</span> <span class="o">=</span> <span class="p">[</span><span class="n">wavefunction</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nbatch</span><span class="p">)]</span>
            <span class="n">wavefunction</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">wavefunction</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># shape:[Nbatch*num_k*norbs*norbs]</span>
            <span class="n">H_sym</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">H_sym</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># shape:(Nbatch*num_k*norbs*norbs)</span>
            <span class="k">return</span> <span class="n">band_energy</span><span class="p">,</span> <span class="n">wavefunction</span><span class="p">,</span> <span class="n">gap</span><span class="p">,</span> <span class="n">H_sym</span>  </div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.cal_band_energy_soc">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.cal_band_energy_soc">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cal_band_energy_soc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Hsoc_on_real</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Hsoc_on_imag</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
                              <span class="n">Hsoc_off_real</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Hsoc_off_imag</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;计算包含自旋轨道耦合（SOC）的能带结构。</span>

<span class="sd">        此方法通过给定的 onsite 和 offsite SOC 哈密顿量的实部和虚部，构建一个 2x2 </span>
<span class="sd">        的块矩阵来表示完整的 SOC 哈密顿量。其中，对角线块是自旋守恒的部分，</span>
<span class="sd">        非对角线块是自旋翻转的部分。然后通过求解该复厄米矩阵的本征值问题得到能带。</span>
<span class="sd">        </span>
<span class="sd">        .. warning::</span>
<span class="sd">           当前实现主要针对 `openmx` 类型的哈密顿量。</span>

<span class="sd">        Args:</span>
<span class="sd">            Hsoc_on_real (torch.Tensor): Onsite SOC 哈密顿量的实部。</span>
<span class="sd">            Hsoc_on_imag (torch.Tensor): Onsite SOC 哈密顿量的虚部。</span>
<span class="sd">            Hsoc_off_real (torch.Tensor): Offsite SOC 哈密顿量的实部。</span>
<span class="sd">            Hsoc_off_imag (torch.Tensor): Offsite SOC 哈密顿量的虚部。</span>
<span class="sd">            data (Data): 输入数据，包含原子结构、k点、重叠矩阵等信息。</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: 返回一个包含能带能量 `band_energy` 和扁平化的波函数 `wavefunction` 的元组。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell</span> <span class="c1"># shape:(Nbatch, 3, 3)</span>
        <span class="n">Nbatch</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># --- 步骤 1: 重塑输入并准备掩码 ---</span>
        <span class="n">Hsoc_on_real</span> <span class="o">=</span> <span class="n">Hsoc_on_real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
        <span class="n">Hsoc_on_imag</span> <span class="o">=</span> <span class="n">Hsoc_on_imag</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
        <span class="n">Hsoc_off_real</span> <span class="o">=</span> <span class="n">Hsoc_off_real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> 
        <span class="n">Hsoc_off_imag</span> <span class="o">=</span> <span class="n">Hsoc_off_imag</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
        
        <span class="c1"># 解析原子轨道基组</span>
        <span class="n">basis_definition</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="c1"># key 是原子序数, value 是占据轨道的索引。</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">basis_definition</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span> <span class="c1"># shape: [Natoms, nao_max] </span>
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">orb_mask</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># shape: [natoms, nao_max]</span>
        <span class="n">orb_mask_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nbatch</span><span class="p">):</span>
            <span class="n">orb_mask_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orb_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span> <span class="n">orb_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># shape: [natoms*nao_max, natoms*nao_max]</span>
        
        <span class="c1"># 设置价电子数</span>
        <span class="n">num_val</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">num_val</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">num_val</span> <span class="o">=</span> <span class="n">num_val</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span> <span class="c1"># shape: [Natoms]</span>
        <span class="n">num_val</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">num_val</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># shape: [Nbatch]</span>
                
        <span class="c1"># 初始化能带窗口</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">band_num_win</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">band_num_win</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">band_num_win</span> <span class="o">=</span> <span class="n">band_num_win</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span> <span class="c1"># shape: [Natoms,]   </span>
            <span class="n">band_num_win</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">band_num_win</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># shape: (Nbatch,)       </span>
            
        <span class="c1"># --- 步骤 2: 按批次分离输入张量 ---</span>
        <span class="n">node_counts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span>
        <span class="n">Hon_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Hsoc_on_real</span><span class="p">,</span> <span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">iHon_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Hsoc_on_imag</span><span class="p">,</span> <span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Son_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Son</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">),</span> <span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">edge_num</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">edge_num</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">edge_num</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Hoff_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Hsoc_off_real</span><span class="p">,</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">iHoff_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Hsoc_off_imag</span><span class="p">,</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Soff_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Soff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">),</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">cell_shift_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">cell_shift</span><span class="p">,</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">nbr_shift_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">nbr_shift</span><span class="p">,</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">edge_index_split</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_num</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">node_num</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">node_counts</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">node_counts</span>
        <span class="n">edge_index_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">edge_index_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">node_num</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_num</span><span class="p">))]</span>
        
        <span class="n">band_energy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">wavefunction</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># --- 步骤 3: 遍历批处理中的每个晶体 ---</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nbatch</span><span class="p">):</span>
            <span class="n">k_vec</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">k_vecs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>   
            <span class="n">natoms</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> 
            
            <span class="c1"># --- 3a: 构建 k 点依赖的 SOC 重叠矩阵 SK ---</span>
            <span class="c1"># 初始化晶胞索引</span>
            <span class="n">cell_shift_tuple</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cell_shift_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
            <span class="n">cell_shift_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cell_shift_tuple</span><span class="p">)</span>
            <span class="n">cell_shift_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cell_shift_set</span><span class="p">)</span>
            <span class="n">cell_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell_shift_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">icell</span><span class="p">)</span> <span class="k">for</span> <span class="n">icell</span> <span class="ow">in</span> <span class="n">cell_shift_tuple</span><span class="p">]</span>
            <span class="n">cell_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">edge_index</span><span class="p">)</span>
            <span class="n">ncells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_shift_set</span><span class="p">)</span>
            
            <span class="c1"># 初始化 SK</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">ncells</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Son</span><span class="p">))</span>
            <span class="n">phase</span><span class="p">[:,</span> <span class="n">cell_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nbr_shift_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="kc">None</span><span class="p">,:,:]</span><span class="o">*</span><span class="n">k_vec</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">na</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

            <span class="n">S_cell</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncells</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Son</span><span class="p">))</span>
            <span class="n">S_cell</span><span class="p">[</span><span class="n">cell_index</span><span class="p">,</span> <span class="n">edge_index_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge_index_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">Soff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

            <span class="n">SK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijklm, ni-&gt;njklm&#39;</span><span class="p">,</span> <span class="n">S_cell</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span> <span class="c1"># (nk, natoms, natoms, nao_max, nao_max)</span>
            <span class="n">SK</span><span class="p">[:,</span><span class="n">na</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span> <span class="o">+=</span>  <span class="n">Son_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">SK</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#(nk, natoms, nao_max, natoms, nao_max)</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">SK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="c1"># 掩码并重塑</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">SK</span><span class="p">[:,</span><span class="n">orb_mask_batch</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">norbs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">SK</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">))</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">SK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">norbs</span><span class="p">,</span> <span class="n">norbs</span><span class="p">)</span>
            <span class="c1"># 构建 SOC 基下的重叠矩阵 (对角块)</span>
            <span class="n">I</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">)</span>
            <span class="n">SK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">SK</span><span class="p">)</span>
            
            <span class="c1"># --- 3b: 构建 k 点依赖的 SOC 哈密顿量 HK ---</span>
            <span class="c1"># on-site term</span>
            <span class="n">H11</span> <span class="o">=</span> <span class="n">Hon_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="n">iHon_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="c1"># up-up</span>
            <span class="n">H12</span> <span class="o">=</span> <span class="n">Hon_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="n">iHon_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="c1"># up-down</span>
            <span class="n">H21</span> <span class="o">=</span> <span class="n">Hon_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="n">iHon_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="c1"># down-up</span>
            <span class="n">H22</span> <span class="o">=</span> <span class="n">Hon_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="n">iHon_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="c1"># down-down</span>
            <span class="n">Hon_soc</span> <span class="o">=</span> <span class="p">[</span><span class="n">H11</span><span class="p">,</span> <span class="n">H12</span><span class="p">,</span> <span class="n">H21</span><span class="p">,</span> <span class="n">H22</span><span class="p">]</span>
            <span class="c1"># off-site term</span>
            <span class="n">H11</span> <span class="o">=</span> <span class="n">Hoff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="n">iHoff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="c1"># up-up</span>
            <span class="n">H12</span> <span class="o">=</span> <span class="n">Hoff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="n">iHoff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="c1"># up-down</span>
            <span class="n">H21</span> <span class="o">=</span> <span class="n">Hoff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="n">iHoff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="c1"># down-up</span>
            <span class="n">H22</span> <span class="o">=</span> <span class="n">Hoff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="n">iHoff_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="c1"># down-down</span>
            <span class="n">Hoff_soc</span> <span class="o">=</span> <span class="p">[</span><span class="n">H11</span><span class="p">,</span> <span class="n">H12</span><span class="p">,</span> <span class="n">H21</span><span class="p">,</span> <span class="n">H22</span><span class="p">]</span>
            
            <span class="c1"># 初始化 HK</span>
            <span class="n">HK_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># 分别为 H11, H12, H21, H22 构建 k 点哈密顿量</span>
            <span class="k">for</span> <span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Hon_soc</span><span class="p">,</span> <span class="n">Hoff_soc</span><span class="p">):</span>
                <span class="n">H_cell</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncells</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Son</span><span class="p">))</span>
                <span class="n">H_cell</span><span class="p">[</span><span class="n">cell_index</span><span class="p">,</span> <span class="n">edge_index_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge_index_split</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">Hoff</span>    

                <span class="n">HK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijklm, ni-&gt;njklm&#39;</span><span class="p">,</span> <span class="n">H_cell</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span> <span class="c1"># (nk, natoms, natoms, nao_max, nao_max)</span>
                <span class="n">HK</span><span class="p">[:,</span><span class="n">na</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span> <span class="o">+=</span>  <span class="n">Hon</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="n">na</span><span class="p">,:,:]</span> <span class="c1"># shape (nk, natoms, nao_max, nao_max)</span>

                <span class="n">HK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">HK</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#(nk, natoms, nao_max, natoms, nao_max)</span>
                <span class="n">HK</span> <span class="o">=</span> <span class="n">HK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">natoms</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

                <span class="c1"># mask HK</span>
                <span class="n">HK</span> <span class="o">=</span> <span class="n">HK</span><span class="p">[:,</span> <span class="n">orb_mask_batch</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">norbs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">HK</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">))</span>
                <span class="n">HK</span> <span class="o">=</span> <span class="n">HK</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">norbs</span><span class="p">,</span> <span class="n">norbs</span><span class="p">)</span>
        
                <span class="n">HK_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HK</span><span class="p">)</span>
            
            <span class="c1"># 将四个块拼接成完整的 SOC 哈密顿量</span>
            <span class="n">HK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">HK_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">HK_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">HK_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">HK_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)],</span><span class="n">dim</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
        
            <span class="c1"># --- 3c: 求解广义本征值问题 ---</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">SK</span><span class="p">)</span>
            <span class="n">L_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">dim0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">L_inv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
            <span class="n">L_t_inv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">L_t</span><span class="p">)</span>
            <span class="n">Hs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">L_inv</span><span class="p">,</span> <span class="n">HK</span><span class="p">),</span> <span class="n">L_t_inv</span><span class="p">)</span>
            <span class="n">orbital_energies</span><span class="p">,</span> <span class="n">orbital_coefficients</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">Hs</span><span class="p">)</span>   
            <span class="c1"># Convert the wavefunction coefficients back to the original basis</span>
            <span class="n">orbital_coefficients</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">L_t_inv</span><span class="p">,</span> <span class="n">orbital_coefficients</span><span class="p">)</span> <span class="c1"># shape:(num_k, Nbands, Nbands)</span>
            
            <span class="c1"># --- 3d: 后处理和存储结果 ---</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">orbital_energies</span> <span class="o">=</span> <span class="n">orbital_energies</span><span class="p">[:,:</span><span class="n">band_num_win</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span>   
                    <span class="n">orbital_coefficients</span> <span class="o">=</span> <span class="n">orbital_coefficients</span><span class="p">[:,:</span><span class="n">band_num_win</span><span class="p">[</span><span class="n">idx</span><span class="p">],:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">orbital_energies</span> <span class="o">=</span> <span class="n">orbital_energies</span><span class="p">[:,</span><span class="n">num_val</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">:</span><span class="n">num_val</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">]</span>   
                    <span class="n">orbital_coefficients</span> <span class="o">=</span> <span class="n">orbital_coefficients</span><span class="p">[:,</span><span class="n">num_val</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">:</span><span class="n">num_val</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,:]</span>
            <span class="n">band_energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">orbital_energies</span><span class="p">,</span> <span class="n">dim0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># [shape:(Nbands, num_k)]</span>
            <span class="n">wavefunction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orbital_coefficients</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">band_energy</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">wavefunction</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.mask_Ham">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.mask_Ham">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mask_Ham</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Hon</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;根据每种原子的实际轨道数，对哈密顿量和重叠矩阵进行掩码操作。</span>

<span class="sd">        此函数确保只有在物理上存在的原子轨道之间的矩阵元才具有非零值，</span>
<span class="sd">        而那些由于使用固定大小 `nao_max` 导致的填充项则被置零。</span>

<span class="sd">        Args:</span>
<span class="sd">            Hon (torch.Tensor): Onsite 矩阵块 (哈密顿量或重叠矩阵)。</span>
<span class="sd">            Hoff (torch.Tensor): Offsite 矩阵块 (哈密顿量或重叠矩阵)。</span>
<span class="sd">            data (Data): 输入数据，需要 `z` 和 `edge_index`。</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: 返回一个元组，包含掩码后的 `(Hon, Hoff)`。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 解析原子轨道基组定义</span>
        <span class="n">basis_definition</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="c1"># key is the atomic number, value is the index of the occupied orbits.</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">basis_definition</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># 保存原始形状以便最后恢复</span>
        <span class="n">original_shape_on</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">original_shape_off</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_shape_on</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">Hon</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape_on</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_shape_off</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">Hoff</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape_off</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># 首先掩码 on-site 矩阵</span>
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="c1"># shape: [Natoms, nao_max] </span>
        <span class="c1"># 通过外积创建 (i, j) 轨道对的掩码</span>
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">orb_mask</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">orb_mask</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:]</span>       <span class="c1"># shape: [Natoms, nao_max, nao_max]</span>
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">orb_mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span> <span class="c1"># shape: [Natoms, nao_max*nao_max]</span>
        
        <span class="n">Hon_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span>
        <span class="n">Hon_mask</span><span class="p">[</span><span class="n">orb_mask</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hon</span><span class="p">[</span><span class="n">orb_mask</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># 接着掩码 off-site 矩阵</span>
        <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>        
        <span class="n">orb_mask_j</span> <span class="o">=</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="c1"># shape: [Nedges, nao_max]</span>
        <span class="n">orb_mask_i</span> <span class="o">=</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="c1"># shape: [Nedges, nao_max] </span>
        <span class="c1"># 通过外积创建 (i, j) 轨道对的掩码</span>
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">orb_mask_j</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">orb_mask_i</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:]</span>       <span class="c1"># shape: [Nedges, nao_max, nao_max]</span>
        <span class="n">orb_mask</span> <span class="o">=</span> <span class="n">orb_mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span> <span class="c1"># shape: [Nedges, nao_max*nao_max]</span>
        
        <span class="n">Hoff_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Hoff</span><span class="p">)</span>
        <span class="n">Hoff_mask</span><span class="p">[</span><span class="n">orb_mask</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hoff</span><span class="p">[</span><span class="n">orb_mask</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 恢复原始形状并返回</span>
        <span class="n">Hon_mask</span> <span class="o">=</span> <span class="n">Hon_mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape_on</span><span class="p">)</span>
        <span class="n">Hoff_mask</span> <span class="o">=</span> <span class="n">Hoff_mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape_off</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Hon_mask</span><span class="p">,</span> <span class="n">Hoff_mask</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.construct_Hsoc">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.construct_Hsoc">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">construct_Hsoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">iH</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;从自旋对角（实部）和自旋非对角（虚部）块构建复数 SOC 哈密顿量。</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            H (torch.Tensor): SOC 哈密顿量的实部块。</span>
<span class="sd">            iH (torch.Tensor): SOC 哈密顿量的虚部块。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: 完整的复数 SOC 哈密顿量张量。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Hsoc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">H</span><span class="p">))</span>
        <span class="n">Hsoc</span> <span class="o">=</span> <span class="n">H</span> <span class="o">+</span> <span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="n">iH</span>
        <span class="k">return</span> <span class="n">Hsoc</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.reduce">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.reduce">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coefficient</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;通过 Clebsch-Gordan 分解，将矩阵块分解为球谐系数（等变特征）。</span>

<span class="sd">        这是 `matrix_merge` 的逆过程。它通过在轨道组内取平均值来近似地提取</span>
<span class="sd">        具有特定角动量 `l` 的特征分量。这主要用于调试或分析目的，以检查</span>
<span class="sd">        网络是否学习到了符合物理对称性的特征。</span>

<span class="sd">        Args:</span>
<span class="sd">            coefficient (torch.Tensor): 形状为 `(N, nao_max, nao_max)` 的矩阵块。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: 分解得到的球谐系数，形状被重新扁平化为 `(N, nao_max*nao_max)`。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 注意：这里的实现是一种近似，它假设同一 l 壳层内的所有 m 分量贡献相同</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">14</span><span class="p">:</span>
            <span class="n">coefficient</span> <span class="o">=</span> <span class="n">coefficient</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">14</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">14</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">19</span><span class="p">:</span>
            <span class="n">coefficient</span> <span class="o">=</span> <span class="n">coefficient</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">14</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">14</span><span class="p">:</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">14</span><span class="p">:</span><span class="mi">19</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">14</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">14</span><span class="p">:</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">14</span><span class="p">:</span><span class="mi">19</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">26</span><span class="p">:</span>
            <span class="n">coefficient</span> <span class="o">=</span> <span class="n">coefficient</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">14</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">14</span><span class="p">:</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">14</span><span class="p">:</span><span class="mi">19</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">19</span><span class="p">:</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="mi">19</span><span class="p">:</span><span class="mi">26</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">14</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">14</span><span class="p">:</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">14</span><span class="p">:</span><span class="mi">19</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">19</span><span class="p">:</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coefficient</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">19</span><span class="p">:</span><span class="mi">26</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coefficient</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.index_cells">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.index_cells">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">index_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_cell_shift_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;将每个唯一的晶胞位移向量映射到其在唯一列表中的索引。</span>

<span class="sd">        Args:</span>
<span class="sd">            unique_cell_shift_list (List[Tuple[int, ...]]): 唯一晶胞位移向量的列表。</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: 一个字典，键是晶胞位移元组，值是其索引。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cell_index_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cell_tuple</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_cell_shift_list</span><span class="p">):</span>
            <span class="n">cell_index_map</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">cell_tuple</span><span class="p">)]</span> <span class="o">=</span> <span class="n">index</span>
        <span class="k">return</span> <span class="n">cell_index_map</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.get_unique_cell_shift_and_cell_shift_indices">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.get_unique_cell_shift_and_cell_shift_indices">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_unique_cell_shift_and_cell_shift_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;从边的晶胞位移中找到唯一的位移向量，并为每条边提供其对应的唯一位移索引。</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            data (Data): PyG 图数据对象。</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: 返回 `(unique_cell_shift, cell_shift_indices, cell_index_map)`。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 匹配 cell_shift 在 unique_cell_shift 中的行索引</span>
        <span class="n">cell_shift</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_shift</span>
        <span class="n">unique_cell_shift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cell_shift</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">zero_vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">unique_cell_shift</span><span class="p">)</span>
        <span class="n">is_zero_vector_present</span> <span class="o">=</span> <span class="p">(</span><span class="n">unique_cell_shift</span> <span class="o">==</span> <span class="n">zero_vector</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        
        <span class="c1"># 如果 (0, 0, 0) 不存在，则将其添加到 unique_cell_shift 中</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_zero_vector_present</span><span class="p">:</span>
            <span class="n">unique_cell_shift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">zero_vector</span><span class="p">,</span> <span class="n">unique_cell_shift</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># 扩展张量以便进行广播比较</span>
        <span class="n">expanded_cell_shift</span> <span class="o">=</span> <span class="n">cell_shift</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">unique_cell_shift</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">expanded_unique_cell_shift</span> <span class="o">=</span> <span class="n">unique_cell_shift</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">cell_shift</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># 比较并找到匹配的行</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">(</span><span class="n">expanded_cell_shift</span> <span class="o">==</span> <span class="n">expanded_unique_cell_shift</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># 获取匹配行的索引</span>
        <span class="n">cell_shift_indices</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># (Nedges,)</span>
        
        <span class="c1"># 获取晶胞索引映射字典</span>
        <span class="n">cell_index_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_cells</span><span class="p">(</span><span class="n">unique_cell_shift</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        
        <span class="k">return</span> <span class="n">unique_cell_shift</span><span class="p">,</span> <span class="n">cell_shift_indices</span><span class="p">,</span> <span class="n">cell_index_map</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">edge_hunter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">inv_edge_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># ... (此函数逻辑复杂且高度特化，保持原有注释风格)</span>
        <span class="n">src</span><span class="p">,</span> <span class="n">tar</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">unique_cell_shift</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">unique_cell_shift</span>
        <span class="n">cell_shift_indices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_shift_indices</span>
        <span class="n">cell_index_map</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_index_map</span>

        <span class="n">num_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">num_shifts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_cell_shift</span><span class="p">)</span>

        <span class="n">edge_matcher_src</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="n">ia</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ia</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">)]</span>
        <span class="n">edge_matcher_tar</span> <span class="o">=</span> <span class="p">[[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_shifts</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">ia</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">):</span>
            <span class="n">inv_src</span> <span class="o">=</span> <span class="n">inv_edge_idx</span><span class="p">[</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">ia</span><span class="p">]]</span>
            <span class="n">cell_shift_inv_src</span> <span class="o">=</span> <span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">inv_src</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">idx_edge</span><span class="p">,</span> <span class="n">idx_cell</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inv_src</span><span class="p">,</span> <span class="n">cell_shift_inv_src</span><span class="p">):</span>
                <span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ia</span><span class="p">][</span><span class="n">idx_cell</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx_edge</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">idx_cell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_shifts</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ia</span><span class="p">][</span><span class="n">idx_cell</span><span class="p">]:</span>
                    <span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ia</span><span class="p">][</span><span class="n">idx_cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ia</span><span class="p">][</span><span class="n">idx_cell</span><span class="p">])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ia</span><span class="p">][</span><span class="n">idx_cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">edge_matcher_src</span><span class="p">,</span> <span class="n">edge_matcher_tar</span>

<div class="viewcode-block" id="HamGNNPlusPlusOut.get_basis_definition">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.get_basis_definition">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_basis_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;为掩码计算创建并返回基组定义张量。</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            z (torch.Tensor): 原子序数张量。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: 一个 `(99, nao_max)` 的张量，其中 `basis_definition[z, i] = 1`</span>
<span class="sd">                          表示原子 `z` 包含轨道 `i`。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">basis_definition</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">:</span>
            <span class="n">basis_definition</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">basis_definition</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.mask_tensor_builder">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.mask_tensor_builder">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mask_tensor_builder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;构建掩码张量并返回拼接后的掩码张量。</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Data): PyG 图数据对象。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: 拼接后的 on-site 和 off-site 掩码。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">z</span>
        <span class="n">basis_definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_basis_definition</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="c1"># 使用 einsum 计算 on-site 和 off-site 掩码</span>
        <span class="n">mask_on</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ni, nj -&gt; nij&#39;</span><span class="p">,</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">z</span><span class="p">],</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>
        <span class="n">mask_off</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ni, nj -&gt; nij&#39;</span><span class="p">,</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>
        <span class="c1"># 拼接并重塑掩码</span>
        <span class="n">mask_all</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">(</span><span class="n">mask_on</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> 
             <span class="n">mask_off</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> 
            <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">mask_all</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.mask_tensor_builder_col">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.mask_tensor_builder_col">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mask_tensor_builder_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;为共线自旋情况构建掩码张量。</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Data): PyG 图数据对象。</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: 适用于共线自旋计算的拼接掩码。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">z</span>
        <span class="n">basis_definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_basis_definition</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="c1"># 使用 einsum 计算 on-site 和 off-site 掩码</span>
        <span class="n">mask_on</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ni, nj -&gt; nij&#39;</span><span class="p">,</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">z</span><span class="p">],</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>
        <span class="n">mask_on</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">mask_on</span><span class="p">,</span> <span class="n">mask_on</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># (Nbatchs, 2, nao_max, nao_max)</span>
        <span class="n">mask_off</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ni, nj -&gt; nij&#39;</span><span class="p">,</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>
        <span class="n">mask_off</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">mask_off</span><span class="p">,</span> <span class="n">mask_off</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># (Nbatchs, 2, nao_max, nao_max)</span>
        <span class="c1"># 拼接并重塑掩码</span>
        <span class="n">mask_all</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">(</span><span class="n">mask_on</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> 
             <span class="n">mask_off</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> 
            <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">mask_all</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.mask_tensor_builder_soc">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.mask_tensor_builder_soc">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mask_tensor_builder_soc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;为包含自旋轨道耦合的情况构建掩码张量。</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Data): PyG 图数据对象。</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: 返回一个元组 `(mask_real_imag, mask_all)`，</span>
<span class="sd">                   分别对应 SOC 哈密顿量的实部/虚部掩码和总掩码。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">z</span>
        <span class="n">basis_definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_basis_definition</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="c1"># 计算基础掩码</span>
        <span class="n">mask_on</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ni, nj -&gt; nij&#39;</span><span class="p">,</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">z</span><span class="p">],</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">z</span><span class="p">])</span>
        <span class="n">mask_off</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ni, nj -&gt; nij&#39;</span><span class="p">,</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="n">basis_definition</span><span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

        <span class="c1"># 扩展张量以包含自旋分量</span>
        <span class="n">mask_on_expanded</span> <span class="o">=</span> <span class="n">blockwise_2x2_concat</span><span class="p">(</span><span class="n">mask_on</span><span class="p">,</span> <span class="n">mask_on</span><span class="p">,</span> <span class="n">mask_on</span><span class="p">,</span> <span class="n">mask_on</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>
        <span class="n">mask_off_expanded</span> <span class="o">=</span> <span class="n">blockwise_2x2_concat</span><span class="p">(</span><span class="n">mask_off</span><span class="p">,</span> <span class="n">mask_off</span><span class="p">,</span> <span class="n">mask_off</span><span class="p">,</span> <span class="n">mask_off</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>

        <span class="c1"># 处理实部和虚部掩码</span>
        <span class="n">mask_real_imag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_onsite_and_offsite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask_on_expanded</span><span class="p">,</span> <span class="n">mask_off_expanded</span><span class="p">)</span>

        <span class="c1"># 拼接所有掩码</span>
        <span class="n">mask_all</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">mask_real_imag</span><span class="p">,</span> <span class="n">mask_real_imag</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mask_real_imag</span><span class="p">,</span> <span class="n">mask_all</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.forward">
<a class="viewcode-back" href="../../../../source/gnn_core.html#HamGNN_v_2_0.models.HamGNN.net.HamGNNPlusPlusOut.forward">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">graph_representation</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;模型的核心前向传播逻辑。</span>

<span class="sd">        该方法根据 `__init__` 中设置的各种开关（如 `soc_switch`, `spin_constrained` 等），</span>
<span class="sd">        执行不同的计算路径来构建哈密顿量和重叠矩阵，并最终计算能带结构等物理属性。</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Data): PyG 图数据对象，可能包含预计算的矩阵。</span>
<span class="sd">            graph_representation (dict, optional): 来自 GNN 表示层的节点和边等变特征字典。</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: 一个包含计算结果的字典，可能包括 &#39;hamiltonian&#39;, &#39;overlap&#39;, </span>
<span class="sd">                  &#39;band_energy&#39;, &#39;wavefunction&#39; 等键。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ... (由于此函数逻辑极为复杂且分支众多，保持原有注释，仅翻译少量关键部分)</span>

        <span class="c1"># To be compatible with the format of Hongyu yu</span>
        <span class="k">if</span> <span class="s1">&#39;H0_u&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">Hon_u0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">H0_u</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Hon_d0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">H0_d</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Hoff_u0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">H0_u</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">):]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Hoff_d0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">H0_d</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">):]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Hon0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Hon_u0</span><span class="p">,</span> <span class="n">Hon_d0</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Hoff0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Hoff_u0</span><span class="p">,</span> <span class="n">Hoff_d0</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Hon</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">H_u</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)],</span> <span class="n">data</span><span class="o">.</span><span class="n">H_d</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">H_u</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">):],</span> <span class="n">data</span><span class="o">.</span><span class="n">H_d</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">):]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    
        <span class="c1"># prepare data.hamiltonian &amp; data.overlap</span>
        <span class="k">if</span> <span class="s1">&#39;hamiltonian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_onsite_and_offsite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;overlap&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_onsite_and_offsite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Son</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Soff</span><span class="p">)</span>
        
        <span class="n">node_attr</span> <span class="o">=</span> <span class="n">graph_representation</span><span class="p">[</span><span class="s1">&#39;node_attr&#39;</span><span class="p">]</span>
        <span class="n">edge_attr</span> <span class="o">=</span> <span class="n">graph_representation</span><span class="p">[</span><span class="s1">&#39;edge_attr&#39;</span><span class="p">]</span>  <span class="c1"># mji</span>
        <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        
        <span class="c1"># Calculate inv_edge_index in batch</span>
        <span class="n">inv_edge_idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">inv_edge_idx</span>
        <span class="n">edge_num</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">edge_num</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">edge_num</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">edge_num</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">edge_num</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">edge_num</span>
        <span class="n">inv_edge_idx</span> <span class="o">=</span> <span class="n">inv_edge_idx</span> <span class="o">+</span> <span class="n">edge_num</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
        
        <span class="c1"># Calculate the on-site Hamiltonian </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>  
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_only</span><span class="p">:</span>
            <span class="n">node_sph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_s</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
            <span class="n">node_sph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">node_sph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Son</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_merge</span><span class="p">(</span><span class="n">node_sph</span><span class="p">)</span> <span class="c1"># shape (Nnodes, nao_max**2)</span>
            
            <span class="n">Son</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_index</span><span class="p">(</span><span class="n">Son</span><span class="p">)</span>
        
            <span class="c1"># Impose Hermitian symmetry for Son</span>
            <span class="n">Son</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hon</span><span class="p">(</span><span class="n">Son</span><span class="p">)</span>

            <span class="c1"># Calculate the off-site overlap</span>
            <span class="c1"># Calculate the contribution of the edges       </span>
            <span class="n">edge_sph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_s</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
            <span class="n">edge_sph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">edge_sph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>        
            <span class="n">Soff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_merge</span><span class="p">(</span><span class="n">edge_sph</span><span class="p">)</span>
        
            <span class="n">Soff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_index</span><span class="p">(</span><span class="n">Soff</span><span class="p">)</span>        
            <span class="c1"># Impose Hermitian symmetry for Soff</span>
            <span class="n">Soff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hoff</span><span class="p">(</span><span class="n">Soff</span><span class="p">,</span> <span class="n">inv_edge_idx</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;openmx&#39;</span><span class="p">,</span><span class="s1">&#39;pasp&#39;</span><span class="p">,</span> <span class="s1">&#39;siesta&#39;</span><span class="p">,</span> <span class="s1">&#39;abacus&#39;</span><span class="p">]:</span>
                <span class="n">Son</span><span class="p">,</span> <span class="n">Soff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_Ham</span><span class="p">(</span><span class="n">Son</span><span class="p">,</span> <span class="n">Soff</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_constrained</span><span class="p">:</span>            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span><span class="p">:</span>
                <span class="c1"># build Hsoc</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">==</span> <span class="s1">&#39;so3&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_H_nonsoc</span><span class="p">:</span>
                        <span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon_nonsoc</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff_nonsoc</span>
                        
                        <span class="c1"># Load the on-site and off-site Hamiltonian matrices</span>
                        <span class="n">Hon0</span><span class="p">,</span> <span class="n">Hoff0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Hon0&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Hoff0&#39;</span><span class="p">]</span>
                    
                        <span class="c1"># Reshape `Hon0` and `Hoff0` into 3D tensors for block-wise manipulation</span>
                        <span class="n">Hon0_resized</span> <span class="o">=</span> <span class="n">Hon0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                        <span class="n">Hoff0_resized</span> <span class="o">=</span> <span class="n">Hoff0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    
                        <span class="c1"># Create zero blocks for the submatrices</span>
                        <span class="n">zero_on</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Son&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                        <span class="n">zero_off</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Soff&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    
                        <span class="c1"># Zero out the upper-left and bottom-right blocks of `Hon0`</span>
                        <span class="n">Hon0_resized</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_on</span>
                        <span class="n">Hon0_resized</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="n">zero_on</span>
                    
                        <span class="c1"># Zero out the upper-left and bottom-right blocks of `Hoff0`</span>
                        <span class="n">Hoff0_resized</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_off</span>
                        <span class="n">Hoff0_resized</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="n">zero_off</span>
                    
                        <span class="c1"># Flatten the processed matrices back to their original shape</span>
                        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Hon0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hon0_resized</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Hoff0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hoff0_resized</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">node_sph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_h</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>     
                        <span class="n">node_sph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">node_sph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">Hon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_merge</span><span class="p">(</span><span class="n">node_sph</span><span class="p">)</span> <span class="c1"># shape (Nnodes, nao_max**2)</span>
    
                        <span class="n">Hon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_index</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span>
    
                        <span class="c1"># Impose Hermitian symmetry for Hon</span>
                        <span class="n">Hon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hon</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span>            
    
                        <span class="c1"># Calculate the off-site Hamiltonian</span>
                        <span class="c1"># Calculate the contribution of the edges       </span>
                        <span class="n">edge_sph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_h</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
                        <span class="n">edge_sph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">edge_sph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>        
                        <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_merge</span><span class="p">(</span><span class="n">edge_sph</span><span class="p">)</span>
    
                        <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_index</span><span class="p">(</span><span class="n">Hoff</span><span class="p">)</span>        
                        <span class="c1"># Impose Hermitian symmetry for Hoff</span>
                        <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hoff</span><span class="p">(</span><span class="n">Hoff</span><span class="p">,</span> <span class="n">inv_edge_idx</span><span class="p">)</span>
    
                        <span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_Ham</span><span class="p">(</span><span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                    <span class="c1"># build Hsoc</span>
                    <span class="n">ksi_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_ksi</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
                    <span class="n">ksi_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ksi_on</span><span class="p">)</span>

                    <span class="n">ksi_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_ksi</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
                    <span class="n">ksi_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ksi_off</span><span class="p">)</span>  

                    <span class="n">Hsoc_on_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Hon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span>
                    <span class="n">Hsoc_on_real</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_on_real</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hon</span><span class="p">((</span><span class="n">ksi_on</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Lon</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_on_real</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hon</span><span class="p">((</span><span class="n">ksi_on</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Lon</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_on_real</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_on_real</span> <span class="o">=</span> <span class="n">Hsoc_on_real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                    <span class="n">Hsoc_on_imag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Hon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span>
                    <span class="n">Hsoc_on_imag</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hon</span><span class="p">((</span><span class="n">ksi_on</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Lon</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]),</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_on_imag</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hon</span><span class="p">((</span><span class="n">ksi_on</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Lon</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_on_imag</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hon</span><span class="p">((</span><span class="n">ksi_on</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Lon</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_on_imag</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hon</span><span class="p">((</span><span class="n">ksi_on</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Lon</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]),</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_on_imag</span> <span class="o">=</span> <span class="n">Hsoc_on_imag</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                    <span class="n">Hsoc_off_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Hoff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hoff</span><span class="p">)</span>
                    <span class="n">Hsoc_off_real</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_off_real</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hoff</span><span class="p">((</span><span class="n">ksi_off</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Loff</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">inv_edge_idx</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_off_real</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hoff</span><span class="p">((</span><span class="n">ksi_off</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Loff</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">inv_edge_idx</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_off_real</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_off_real</span> <span class="o">=</span> <span class="n">Hsoc_off_real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                    <span class="n">Hsoc_off_imag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Hoff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hoff</span><span class="p">)</span>
                    <span class="n">Hsoc_off_imag</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hoff</span><span class="p">((</span><span class="n">ksi_off</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Loff</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]),</span> <span class="n">inv_edge_idx</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_off_imag</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hoff</span><span class="p">((</span><span class="n">ksi_off</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Loff</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">inv_edge_idx</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_off_imag</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hoff</span><span class="p">((</span><span class="n">ksi_off</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Loff</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">inv_edge_idx</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_off_imag</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hoff</span><span class="p">((</span><span class="n">ksi_off</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Loff</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]),</span> <span class="n">inv_edge_idx</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_off_imag</span> <span class="o">=</span> <span class="n">Hsoc_off_imag</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">==</span> <span class="s1">&#39;su2&#39;</span><span class="p">:</span>
                    <span class="n">node_sph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_h</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span> 

                    <span class="n">Hon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamDecomp</span><span class="o">.</span><span class="n">get_H</span><span class="p">(</span><span class="n">node_sph</span><span class="p">)</span> <span class="c1"># shape [Nbatchs, (4 spin components,) H_flattened_concatenated]</span>
                    <span class="n">Hon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_index</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span>
                    <span class="n">Hon</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>                
                    <span class="n">Hon</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">Hon</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># shape (Nnodes, 2, nao_max, 2, nao_max)</span>

                    <span class="c1"># Calculate the off-site Hamiltonian</span>
                    <span class="c1"># Calculate the contribution of the edges       </span>
                    <span class="n">edge_sph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_h</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>

                    <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamDecomp</span><span class="o">.</span><span class="n">get_H</span><span class="p">(</span><span class="n">edge_sph</span><span class="p">)</span> <span class="c1"># shape [Nbatchs, (4 spin components,) H_flattened_concatenated]</span>
                    <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_index</span><span class="p">(</span><span class="n">Hoff</span><span class="p">)</span>
                    <span class="n">Hoff</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hoff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">Hoff</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># shape (Nedges, 2, nao_max, 2, nao_max)    </span>

                    <span class="c1"># mask zeros         </span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                            <span class="n">Hon</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:,</span><span class="n">j</span><span class="p">,:],</span> <span class="n">Hoff</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:,</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_Ham</span><span class="p">(</span><span class="n">Hon</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:,</span><span class="n">j</span><span class="p">,:],</span> <span class="n">Hoff</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:,</span><span class="n">j</span><span class="p">,:],</span> <span class="n">data</span><span class="p">)</span>
                    <span class="n">Hon</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">Hoff</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># build four parts</span>
                    <span class="n">Hsoc_on_real</span> <span class="o">=</span>  <span class="n">Hon</span><span class="o">.</span><span class="n">real</span>
                    <span class="n">Hsoc_off_real</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">real</span>
                    <span class="n">Hsoc_on_imag</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">imag</span>
                    <span class="n">Hsoc_off_imag</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">imag</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_sph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_h</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>     
                <span class="n">node_sph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">node_sph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Hon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_merge</span><span class="p">(</span><span class="n">node_sph</span><span class="p">)</span> <span class="c1"># shape (Nnodes, nao_max**2)</span>
                <span class="n">Hon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_index</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span>
                <span class="c1"># Impose Hermitian symmetry for Hon</span>
                <span class="n">Hon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hon</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span>            
                <span class="c1"># Calculate the off-site Hamiltonian</span>
                <span class="c1"># Calculate the contribution of the edges       </span>
                <span class="n">edge_sph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_h</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
                <span class="n">edge_sph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">edge_sph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>        
                <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_merge</span><span class="p">(</span><span class="n">edge_sph</span><span class="p">)</span>
                <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_index</span><span class="p">(</span><span class="n">Hoff</span><span class="p">)</span>        
                <span class="c1"># Impose Hermitian symmetry for Hoff</span>
                <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hoff</span><span class="p">(</span><span class="n">Hoff</span><span class="p">,</span> <span class="n">inv_edge_idx</span><span class="p">)</span>
                <span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_Ham</span><span class="p">(</span><span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span><span class="p">:</span>
                    <span class="n">Hsoc_on_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Hon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_on_real</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_on_real</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_on_real</span> <span class="o">=</span> <span class="n">Hsoc_on_real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Hon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    
                    <span class="n">Hsoc_off_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Hoff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_off_real</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_off_real</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">Hsoc_off_real</span> <span class="o">=</span> <span class="n">Hsoc_off_real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Hoff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    
                    <span class="n">Hsoc_on_imag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iHon</span><span class="p">)</span> 
                    <span class="n">Hsoc_off_imag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iHoff</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_constrained</span><span class="p">:</span>
                <span class="n">magnetic_atoms</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">spin_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">minMagneticMoment</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">unique_cell_shift</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_shift_indices</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_index_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unique_cell_shift_and_cell_shift_indices</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">cell_shift_indices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_shift_indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">cell_index_map</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_index_map</span>
                
                <span class="c1"># learn a weight matrix</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_learned_weight</span><span class="p">:</span>
                    <span class="n">node_sph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_weight</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>     
                    <span class="n">node_sph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">node_sph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">weight_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_merge</span><span class="p">(</span><span class="n">node_sph</span><span class="p">)</span> <span class="c1"># shape (Nnodes, nao_max**2)</span>
            
                    <span class="n">weight_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_index</span><span class="p">(</span><span class="n">weight_on</span><span class="p">)</span>

                    <span class="c1"># Impose Hermitian symmetry for Hon</span>
                    <span class="n">weight_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hon</span><span class="p">(</span><span class="n">weight_on</span><span class="p">)</span>           

                    <span class="c1"># Calculate the off-site Hamiltonian</span>
                    <span class="c1"># Calculate the contribution of the edges       </span>
                    <span class="n">edge_sph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_weight</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
                    <span class="n">edge_sph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">edge_sph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>        
                    <span class="n">weight_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_merge</span><span class="p">(</span><span class="n">edge_sph</span><span class="p">)</span>
        
                    <span class="n">weight_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_index</span><span class="p">(</span><span class="n">weight_off</span><span class="p">)</span>        
                    <span class="c1"># Impose Hermitian symmetry for Hoff</span>
                    <span class="n">weight_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hoff</span><span class="p">(</span><span class="n">weight_off</span><span class="p">,</span> <span class="n">inv_edge_idx</span><span class="p">)</span>
                    
                    <span class="n">weight_on</span><span class="p">,</span> <span class="n">weight_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_Ham</span><span class="p">(</span><span class="n">weight_on</span><span class="p">,</span> <span class="n">weight_off</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="n">weight_on</span><span class="p">,</span> <span class="n">weight_off</span> <span class="o">=</span> <span class="n">weight_on</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">),</span> <span class="n">weight_off</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">weight_on</span> <span class="o">=</span> <span class="n">weight_on</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">weight_off</span> <span class="o">=</span> <span class="n">weight_off</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span><span class="p">:</span>
                    <span class="n">J_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_J</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>     
                    <span class="n">J_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_merge</span><span class="p">(</span><span class="n">J_on</span><span class="p">)</span> <span class="c1"># shape: (Natoms, nao_max, nao_max, 3, 3)</span>

                    <span class="n">J_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_J</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span> <span class="c1"># shape: (Nedges, Nblocks)    </span>
                    <span class="n">J_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_merge</span><span class="p">(</span><span class="n">J_off</span><span class="p">)</span> <span class="c1"># shape: (Nedges, nao_max, nao_max, 3, 3)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_quartic</span><span class="p">:</span>
                        <span class="n">K_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_K</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span> <span class="c1"># shape: (Natoms, Nblocks)    </span>
                        <span class="n">K_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K_merge</span><span class="p">(</span><span class="n">K_on</span><span class="p">)</span> <span class="c1"># shape: (Natoms, nao_max, nao_max)</span>

                        <span class="n">K_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_K</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>  <span class="c1"># shape: (Nedges, Nblocks)    </span>
                        <span class="n">K_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K_merge</span><span class="p">(</span><span class="n">K_off</span><span class="p">)</span> <span class="c1"># shape: (Nedges, nao_max, nao_max)</span>

                    <span class="n">sigma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">J_on</span><span class="p">))</span>
                    <span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                    <span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">real</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="n">imag</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]]))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> 
                    <span class="n">sigma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> 

                    <span class="n">spin_vec</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">spin_vec</span>

                    <span class="c1"># brodcast shape: (Natoms/Nedges, Natoms/Nedges, 2, nao_max, 2, nao_max)</span>
                    <span class="n">H_heisen_J_on</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_on</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                    <span class="n">H_heisen_J_off</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

                    <span class="c1"># Optimize Performance</span>
                    <span class="n">edge_matcher_src</span><span class="p">,</span> <span class="n">edge_matcher_tar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_hunter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">inv_edge_idx</span><span class="p">)</span>           

                    <span class="n">H_heisen_J_on</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;mijkl, mij, kop, ml -&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_on</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">weight_on</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>    
                    <span class="n">H_heisen_J_on</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;mijkl, mij, lop, mk -&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_on</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">weight_on</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

                    <span class="n">zero_shift_idx</span> <span class="o">=</span> <span class="n">cell_index_map</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">ia</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_on</span><span class="p">)):</span>
                        <span class="c1"># src</span>
                        <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">ia</span><span class="p">]:</span>
                            <span class="n">zero_shift_edges</span> <span class="o">=</span> <span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ia</span><span class="p">][</span><span class="n">zero_shift_idx</span><span class="p">]</span>
                            <span class="n">edge_matcher_src_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">ia</span><span class="p">],</span> <span class="n">zero_shift_edges</span><span class="p">])</span>
                            <span class="n">Woff</span> <span class="o">=</span> <span class="n">weight_off</span><span class="p">[</span><span class="n">edge_matcher_src_</span><span class="p">]</span>                    
                            <span class="n">H_heisen_J_off</span><span class="p">[</span><span class="n">edge_matcher_src_</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ijkl, mij, kop, l -&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_on</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">Woff</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
                            <span class="n">H_heisen_J_off</span><span class="p">[</span><span class="n">edge_matcher_src_</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ijkl, mij, lop, k -&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_on</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">Woff</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
                    
                    <span class="k">for</span> <span class="n">i_edge</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)):</span>
                        <span class="n">ia</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                        <span class="n">ja</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                        <span class="c1"># i</span>
                        <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">ja</span><span class="p">]:</span>
                            <span class="n">Won</span> <span class="o">=</span> <span class="n">weight_on</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span>
                            <span class="n">Woff_src</span> <span class="o">=</span> <span class="n">weight_off</span><span class="p">[</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">ia</span><span class="p">]]</span>
                            <span class="n">H_heisen_J_on</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ijkl, ij, kop, l -&gt; oipj&#39;</span><span class="p">,</span> <span class="n">J_off</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">Won</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">ja</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
                            <span class="n">H_heisen_J_off</span><span class="p">[</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">ia</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ijkl, mij, kop, l -&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_off</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">Woff_src</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">ja</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

                        <span class="c1"># j</span>
                        <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">ia</span><span class="p">]:</span>
                            <span class="n">Woff_tar</span> <span class="o">=</span> <span class="n">weight_off</span><span class="p">[</span><span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ja</span><span class="p">][</span><span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]]]</span>
                            <span class="n">H_heisen_J_off</span><span class="p">[</span><span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ja</span><span class="p">][</span><span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]]]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ijkl, mij, lop, k -&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_off</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">Woff_tar</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_index_map</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)]:</span>
                                <span class="n">Won</span> <span class="o">=</span> <span class="n">weight_on</span><span class="p">[</span><span class="n">ja</span><span class="p">]</span>
                                <span class="n">H_heisen_J_on</span><span class="p">[</span><span class="n">ja</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ijkl, ij, lop, k -&gt; oipj&#39;</span><span class="p">,</span> <span class="n">J_off</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">Won</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>   
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">J_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_J</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span> <span class="c1"># shape: (Natoms, Nblocks)  </span>
                    <span class="n">J_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_merge</span><span class="p">(</span><span class="n">J_on</span><span class="p">)</span> <span class="c1"># shape: (Natoms, nao_max, nao_max,)</span>
    
                    <span class="n">J_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_J</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span> <span class="c1"># shape: (Nedges, Nblocks)</span>
                    <span class="n">J_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_merge</span><span class="p">(</span><span class="n">J_off</span><span class="p">)</span> <span class="c1"># shape: (Nedges, nao_max, nao_max,)</span>
    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_quartic</span><span class="p">:</span>
                        <span class="n">K_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_K</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span> <span class="c1"># shape: (Natoms, Nblocks)    </span>
                        <span class="n">K_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K_merge</span><span class="p">(</span><span class="n">K_on</span><span class="p">)</span> <span class="c1"># shape: (Natoms, nao_max, nao_max)</span>
                                        
                        <span class="n">K_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_K</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span> <span class="c1"># shape: (Nedges, Nblocks)</span>
                        <span class="n">K_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K_merge</span><span class="p">(</span><span class="n">K_off</span><span class="p">)</span> <span class="c1"># shape: (Nedges, nao_max, nao_max)               </span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span><span class="p">:</span>
                        <span class="n">sigma_z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">J_on</span><span class="p">)</span> 

                        <span class="n">spin_vec</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">spin_vec</span>

                        <span class="c1"># brodcast shape: (Natoms/Nedges, Natoms/Nedges, 2, nao_max, 2, nao_max)</span>
                        <span class="n">H_heisen_J_on</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_on</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">J_on</span><span class="p">)</span> 
                        <span class="n">H_heisen_J_off</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">J_off</span><span class="p">)</span> 

                        <span class="c1"># Optimize Performance</span>
                        <span class="n">edge_matcher_src</span><span class="p">,</span> <span class="n">edge_matcher_tar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_hunter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">inv_edge_idx</span><span class="p">)</span>           

                        <span class="n">H_heisen_J_on</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;mij, mij, op, m -&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_on</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">],</span> <span class="n">weight_on</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">],</span> <span class="n">sigma_z</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>

                        <span class="n">zero_shift_idx</span> <span class="o">=</span> <span class="n">cell_index_map</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">ia</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_on</span><span class="p">)):</span>
                            <span class="c1"># src</span>
                            <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">ia</span><span class="p">]:</span>
                                <span class="n">zero_shift_edges</span> <span class="o">=</span> <span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ia</span><span class="p">][</span><span class="n">zero_shift_idx</span><span class="p">]</span>
                                <span class="n">edge_matcher_src_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">ia</span><span class="p">],</span> <span class="n">zero_shift_edges</span><span class="p">])</span>
                                <span class="n">Woff</span> <span class="o">=</span> <span class="n">weight_off</span><span class="p">[</span><span class="n">edge_matcher_src_</span><span class="p">]</span>   
                                <span class="n">H_heisen_J_off</span><span class="p">[</span><span class="n">edge_matcher_src_</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij, mij, op-&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_on</span><span class="p">[</span><span class="n">ia</span><span class="p">],</span> <span class="n">Woff</span><span class="p">,</span> <span class="n">sigma_z</span><span class="p">)</span><span class="o">*</span><span class="n">spin_vec</span><span class="p">[</span><span class="n">ia</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">i_edge</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)):</span>
                            <span class="n">ia</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                            <span class="n">ja</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                            <span class="c1"># i</span>
                            <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">ja</span><span class="p">]:</span>
                                <span class="n">Won</span> <span class="o">=</span> <span class="n">weight_on</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span>
                                <span class="n">Woff_src</span> <span class="o">=</span> <span class="n">weight_off</span><span class="p">[</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">ia</span><span class="p">]]</span>
                                <span class="n">H_heisen_J_on</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij, ij, op-&gt; oipj&#39;</span><span class="p">,</span> <span class="n">J_off</span><span class="p">[</span><span class="n">i_edge</span><span class="p">],</span> <span class="n">Won</span><span class="p">,</span> <span class="n">sigma_z</span><span class="p">)</span><span class="o">*</span><span class="n">spin_vec</span><span class="p">[</span><span class="n">ja</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                                <span class="n">H_heisen_J_off</span><span class="p">[</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">ia</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij, mij, op -&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_off</span><span class="p">[</span><span class="n">i_edge</span><span class="p">],</span> <span class="n">Woff_src</span><span class="p">,</span> <span class="n">sigma_z</span><span class="p">)</span><span class="o">*</span><span class="n">spin_vec</span><span class="p">[</span><span class="n">ja</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

                            <span class="c1"># j</span>
                            <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">ia</span><span class="p">]:</span>
                                <span class="n">Woff_tar</span> <span class="o">=</span> <span class="n">weight_off</span><span class="p">[</span><span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ja</span><span class="p">][</span><span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]]]</span>
                                <span class="n">H_heisen_J_off</span><span class="p">[</span><span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ja</span><span class="p">][</span><span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]]]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij, mij, op -&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_off</span><span class="p">[</span><span class="n">i_edge</span><span class="p">],</span> <span class="n">Woff_tar</span><span class="p">,</span> <span class="n">sigma_z</span><span class="p">)</span><span class="o">*</span><span class="n">spin_vec</span><span class="p">[</span><span class="n">ia</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_index_map</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)]:</span>
                                    <span class="n">Won</span> <span class="o">=</span> <span class="n">weight_on</span><span class="p">[</span><span class="n">ja</span><span class="p">]</span>
                                    <span class="n">H_heisen_J_on</span><span class="p">[</span><span class="n">ja</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij, ij, op-&gt; oipj&#39;</span><span class="p">,</span> <span class="n">J_off</span><span class="p">[</span><span class="n">i_edge</span><span class="p">],</span> <span class="n">Won</span><span class="p">,</span> <span class="n">sigma_z</span><span class="p">)</span><span class="o">*</span><span class="n">spin_vec</span><span class="p">[</span><span class="n">ia</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>                 
                        <span class="n">sigma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">J_on</span><span class="p">))</span>
                        <span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                        <span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">real</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="n">imag</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]]))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> 
                        <span class="n">sigma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">real</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="n">imag</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]]))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> 

                        <span class="n">spin_vec</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">spin_vec</span>

                        <span class="c1"># brodcast shape: (Natoms/Nedges, Natoms/Nedges, 2, nao_max, 2, nao_max)</span>
                        <span class="n">H_heisen_J_on</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_on</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                        <span class="n">H_heisen_J_off</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

                        <span class="c1"># Optimize Performance</span>
                        <span class="n">edge_matcher_src</span><span class="p">,</span> <span class="n">edge_matcher_tar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_hunter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">inv_edge_idx</span><span class="p">)</span>          

                        <span class="n">H_heisen_J_on</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;mij, mij, kop, mk -&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_on</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">weight_on</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

                        <span class="n">zero_shift_idx</span> <span class="o">=</span> <span class="n">cell_index_map</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">ia</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_on</span><span class="p">)):</span>
                            <span class="c1"># src</span>
                            <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">ia</span><span class="p">]:</span>
                                <span class="n">zero_shift_edges</span> <span class="o">=</span> <span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ia</span><span class="p">][</span><span class="n">zero_shift_idx</span><span class="p">]</span>
                                <span class="n">edge_matcher_src_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">ia</span><span class="p">],</span> <span class="n">zero_shift_edges</span><span class="p">])</span>
                                <span class="n">Woff</span> <span class="o">=</span> <span class="n">weight_off</span><span class="p">[</span><span class="n">edge_matcher_src_</span><span class="p">]</span>  
                                <span class="n">H_heisen_J_off</span><span class="p">[</span><span class="n">edge_matcher_src_</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij, mij, kop, k -&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_on</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">Woff</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

                        <span class="k">for</span> <span class="n">i_edge</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)):</span>
                            <span class="n">ia</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                            <span class="n">ja</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                            <span class="c1"># i</span>
                            <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">ja</span><span class="p">]:</span>
                                <span class="n">Won</span> <span class="o">=</span> <span class="n">weight_on</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span>
                                <span class="n">Woff_src</span> <span class="o">=</span> <span class="n">weight_off</span><span class="p">[</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">ia</span><span class="p">]]</span>
                                <span class="n">H_heisen_J_on</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij, ij, kop, k -&gt; oipj&#39;</span><span class="p">,</span> <span class="n">J_off</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">Won</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">ja</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
                                <span class="n">H_heisen_J_off</span><span class="p">[</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">ia</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij, mij, kop, k -&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_off</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">Woff_src</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">ja</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

                            <span class="c1"># j</span>
                            <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">ia</span><span class="p">]:</span>
                                <span class="n">Woff_tar</span> <span class="o">=</span> <span class="n">weight_off</span><span class="p">[</span><span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ja</span><span class="p">][</span><span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]]]</span>
                                <span class="n">H_heisen_J_off</span><span class="p">[</span><span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">ja</span><span class="p">][</span><span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]]]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij, mij, kop, k -&gt; moipj&#39;</span><span class="p">,</span> <span class="n">J_off</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">Woff_tar</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_index_map</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)]:</span>
                                    <span class="n">Won</span> <span class="o">=</span> <span class="n">weight_on</span><span class="p">[</span><span class="n">ja</span><span class="p">]</span>
                                    <span class="n">H_heisen_J_on</span><span class="p">[</span><span class="n">ja</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="s1">&#39;ij, ij, kop, k -&gt; oipj&#39;</span><span class="p">,</span> <span class="n">J_off</span><span class="p">[</span><span class="n">i_edge</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">Won</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>                                

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span><span class="p">:</span>
                    <span class="n">Hsoc_on_real</span> <span class="o">=</span>  <span class="n">Hsoc_on_real</span> <span class="o">+</span> <span class="n">H_heisen_J_on</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
                    <span class="n">Hsoc_off_real</span> <span class="o">=</span> <span class="n">Hsoc_off_real</span> <span class="o">+</span> <span class="n">H_heisen_J_off</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
                    <span class="n">Hsoc_on_imag</span> <span class="o">=</span> <span class="n">Hsoc_on_imag</span> <span class="o">+</span> <span class="n">H_heisen_J_on</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span>
                    <span class="n">Hsoc_off_imag</span> <span class="o">=</span> <span class="n">Hsoc_off_imag</span> <span class="o">+</span> <span class="n">H_heisen_J_off</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">:</span>
                        <span class="n">Hsoc_on_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hon_soc</span><span class="p">(</span><span class="n">Hsoc_on_real</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
                        <span class="n">Hsoc_off_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hoff_soc</span><span class="p">(</span><span class="n">Hsoc_off_real</span><span class="p">,</span> <span class="n">inv_edge_idx</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
                        <span class="n">Hsoc_on_imag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hon_soc</span><span class="p">(</span><span class="n">Hsoc_on_imag</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                        <span class="n">Hsoc_off_imag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hoff_soc</span><span class="p">(</span><span class="n">Hsoc_off_imag</span><span class="p">,</span> <span class="n">inv_edge_idx</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Hcol_on</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_heisen_J_on</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">Hon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_heisen_J_on</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">,:]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">Hcol_off</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_heisen_J_off</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">Hoff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_heisen_J_off</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">,:]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_H0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span><span class="p">:</span>
                    <span class="n">Hsoc_on_real</span> <span class="o">=</span>  <span class="n">Hsoc_on_real</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon0</span>
                    <span class="n">Hsoc_off_real</span> <span class="o">=</span> <span class="n">Hsoc_off_real</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff0</span>
                    <span class="n">Hsoc_on_imag</span> <span class="o">=</span> <span class="n">Hsoc_on_imag</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">iHon0</span>
                    <span class="n">Hsoc_off_imag</span> <span class="o">=</span> <span class="n">Hsoc_off_imag</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">iHoff0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Hcol_on</span> <span class="o">=</span>  <span class="n">Hcol_on</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon0</span>
                    <span class="n">Hcol_off</span> <span class="o">=</span> <span class="n">Hcol_off</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff0</span>   

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span><span class="p">:</span>
                <span class="n">Hsoc_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_onsite_and_offsite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Hsoc_on_real</span><span class="p">,</span> <span class="n">Hsoc_off_real</span><span class="p">)</span>
                <span class="n">Hsoc_imag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_onsite_and_offsite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Hsoc_on_imag</span><span class="p">,</span> <span class="n">Hsoc_off_imag</span><span class="p">)</span>

                <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_onsite_and_offsite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian_imag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_onsite_and_offsite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">iHon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">iHoff</span><span class="p">)</span>

                <span class="n">Hsoc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">Hsoc_real</span><span class="p">,</span> <span class="n">Hsoc_imag</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">hamiltonian_real</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian_imag</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energy</span><span class="p">:</span>
                    <span class="n">k_vecs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">cell</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell</span>
                        <span class="c1"># Generate K point path</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">kpts</span><span class="o">=</span><span class="n">kpoints_generator</span><span class="p">(</span><span class="n">dim_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                            <span class="n">k_vec</span><span class="p">,</span> <span class="n">k_dist</span><span class="p">,</span> <span class="n">k_node</span><span class="p">,</span> <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">kpts</span><span class="o">.</span><span class="n">k_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lat_per_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">k_vec</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span> <span class="c1">#(-1, 1)</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="n">k_vec</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lat_per_inv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:])</span> <span class="c1"># shape (nk,1,3)</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="n">k_vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># shape (nk, 3)</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">k_vec</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span>
                        <span class="n">k_vecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_vec</span><span class="p">)</span>  
                    <span class="n">data</span><span class="o">.</span><span class="n">k_vecs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">k_vecs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">band_energy</span><span class="p">,</span> <span class="n">wavefunction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_band_energy_soc</span><span class="p">(</span><span class="n">Hsoc_on_real</span><span class="p">,</span> <span class="n">Hsoc_on_imag</span><span class="p">,</span> <span class="n">Hsoc_off_real</span><span class="p">,</span> <span class="n">Hsoc_off_imag</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> 
                    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">band_energy</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">wavefunction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_band_energy_soc</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">iHon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">iHoff</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">band_energy</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">wavefunction</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>                
                <span class="n">Hcol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_onsite_and_offsite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Hcol_on</span><span class="p">,</span> <span class="n">Hcol_off</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_onsite_and_offsite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">)</span>
                
                <span class="c1"># cal band energy</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energy</span><span class="p">:</span>
                    <span class="n">k_vecs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">cell</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell</span>
                        <span class="c1"># Generate K point path</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">kpts</span><span class="o">=</span><span class="n">kpoints_generator</span><span class="p">(</span><span class="n">dim_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                            <span class="n">k_vec</span><span class="p">,</span> <span class="n">k_dist</span><span class="p">,</span> <span class="n">k_node</span><span class="p">,</span> <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">kpts</span><span class="o">.</span><span class="n">k_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                            <span class="c1"># build crystal structure</span>
                            <span class="n">latt</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">*</span><span class="n">au2ang</span>
                            <span class="n">pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">*</span><span class="n">au2ang</span>
                            <span class="n">species</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
                            <span class="n">struct</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span><span class="n">lattice</span><span class="o">=</span><span class="n">latt</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="p">[</span><span class="n">Element</span><span class="o">.</span><span class="n">from_Z</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">item</span><span class="p">())</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">species</span><span class="p">],</span> <span class="n">coords</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="c1"># Initialize k_path and label</span>
                            <span class="n">kpath_seek</span> <span class="o">=</span> <span class="n">KPathSeek</span><span class="p">(</span><span class="n">structure</span> <span class="o">=</span> <span class="n">struct</span><span class="p">)</span>
                            <span class="n">klabels</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">lbs</span> <span class="ow">in</span> <span class="n">kpath_seek</span><span class="o">.</span><span class="n">kpath</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]:</span>
                                <span class="n">klabels</span> <span class="o">+=</span> <span class="n">lbs</span>
                            <span class="c1"># remove adjacent duplicates   </span>
                            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">klabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">klabels</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="n">klabels</span> <span class="o">=</span> <span class="n">res</span>
                            <span class="n">k_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">kpath_seek</span><span class="o">.</span><span class="n">kpath</span><span class="p">[</span><span class="s1">&#39;kpoints&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">klabels</span><span class="p">]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">kpts</span><span class="o">=</span><span class="n">kpoints_generator</span><span class="p">(</span><span class="n">dim_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                                <span class="n">k_vec</span><span class="p">,</span> <span class="n">k_dist</span><span class="p">,</span> <span class="n">k_node</span><span class="p">,</span> <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">kpts</span><span class="o">.</span><span class="n">k_path</span><span class="p">(</span><span class="n">k_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">lat_per_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span>
                                <span class="n">k_vec</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span> <span class="c1">#(-1, 1)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lat_per_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">k_vec</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span> <span class="c1">#(-1, 1)</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="n">k_vec</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lat_per_inv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:])</span> <span class="c1"># shape (nk,1,3)</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="n">k_vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># shape (nk, 3)</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">k_vec</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span>
                        <span class="n">k_vecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_vec</span><span class="p">)</span>  
                    <span class="n">data</span><span class="o">.</span><span class="n">k_vecs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">k_vecs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_reciprocal_values</span><span class="p">:</span>
                        <span class="n">band_energy_up</span><span class="p">,</span> <span class="n">wavefunction_up</span><span class="p">,</span> <span class="n">HK_up</span><span class="p">,</span> <span class="n">SK_up</span><span class="p">,</span> <span class="n">dSK_up</span><span class="p">,</span> <span class="n">gap_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_band_energy</span><span class="p">(</span><span class="n">Hcol_on</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">Hcol_off</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="n">band_energy_down</span><span class="p">,</span> <span class="n">wavefunction_down</span><span class="p">,</span> <span class="n">HK_down</span><span class="p">,</span> <span class="n">SK_down</span><span class="p">,</span> <span class="n">dSK_down</span><span class="p">,</span> <span class="n">gap_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_band_energy</span><span class="p">(</span><span class="n">Hcol_on</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">Hcol_off</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="n">H_sym</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">band_energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">band_energy_up</span><span class="p">,</span> <span class="n">band_energy_down</span><span class="p">])</span>
                        <span class="n">wavefunction</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">wavefunction_up</span><span class="p">,</span> <span class="n">wavefunction_down</span><span class="p">])</span>
                        <span class="n">HK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">HK_up</span><span class="p">,</span> <span class="n">HK_down</span><span class="p">])</span>
                        <span class="n">gap</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">gap_up</span><span class="p">,</span> <span class="n">gap_down</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">band_energy_up</span><span class="p">,</span> <span class="n">wavefunction_up</span><span class="p">,</span> <span class="n">gap_up</span><span class="p">,</span> <span class="n">H_sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_band_energy</span><span class="p">(</span><span class="n">Hcol_on</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">Hcol_off</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">data</span><span class="p">)</span>
                        <span class="n">band_energy_down</span><span class="p">,</span> <span class="n">wavefunction_down</span><span class="p">,</span> <span class="n">gap_down</span><span class="p">,</span> <span class="n">H_sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_band_energy</span><span class="p">(</span><span class="n">Hcol_on</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">Hcol_off</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">data</span><span class="p">)</span>
                        <span class="n">band_energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">band_energy_up</span><span class="p">,</span> <span class="n">band_energy_down</span><span class="p">])</span>
                        <span class="n">wavefunction</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">wavefunction_up</span><span class="p">,</span> <span class="n">wavefunction_down</span><span class="p">])</span>
                        <span class="n">gap</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">gap_up</span><span class="p">,</span> <span class="n">gap_down</span><span class="p">])</span>
                    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">band_energy_up</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">wavefunction</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">band_gap_up</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">H_sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_band_energy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">data</span><span class="p">)</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">band_energy_down</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">wavefunction</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">band_gap_down</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">H_sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_band_energy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">data</span><span class="p">)</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">band_energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">band_energy_up</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">band_energy_down</span><span class="p">])</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">band_gap</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">band_gap_up</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">band_gap_down</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">band_energy</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">wavefunction</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">gap</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">H_sym</span> <span class="o">=</span> <span class="kc">None</span>        
        
        <span class="c1"># non-soc and non-magnetic</span>
        <span class="k">else</span><span class="p">:</span>                
            <span class="n">node_sph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsitenet_h</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
            <span class="n">node_sph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">node_sph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Hon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_merge</span><span class="p">(</span><span class="n">node_sph</span><span class="p">)</span> <span class="c1"># shape (Nnodes, nao_max**2)</span>
            
            <span class="n">Hon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_index</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span>
        
            <span class="c1"># Impose Hermitian symmetry for Hon</span>
            <span class="n">Hon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hon</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_H0</span><span class="p">:</span>
                <span class="n">Hon</span> <span class="o">=</span> <span class="n">Hon</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon0</span>

            <span class="c1"># Calculate the off-site Hamiltonian</span>
            <span class="c1"># Calculate the contribution of the edges       </span>
            <span class="n">edge_sph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsitenet_h</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
            <span class="n">edge_sph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">edge_sph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_irreps_dim</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>        
            <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_merge</span><span class="p">(</span><span class="n">edge_sph</span><span class="p">)</span>
        
            <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_index</span><span class="p">(</span><span class="n">Hoff</span><span class="p">)</span>        
            <span class="c1"># Impose Hermitian symmetry for Hoff</span>
            <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_Hoff</span><span class="p">(</span><span class="n">Hoff</span><span class="p">,</span> <span class="n">inv_edge_idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_H0</span><span class="p">:</span>
                <span class="n">Hoff</span> <span class="o">=</span> <span class="n">Hoff</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff0</span>
        
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;openmx&#39;</span><span class="p">,</span><span class="s1">&#39;pasp&#39;</span><span class="p">,</span> <span class="s1">&#39;siesta&#39;</span><span class="p">,</span> <span class="s1">&#39;abacus&#39;</span><span class="p">]:</span>
                <span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_Ham</span><span class="p">(</span><span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energy</span><span class="p">:</span>
                <span class="n">k_vecs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell</span>
                    <span class="c1"># Generate K point path</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">kpts</span><span class="o">=</span><span class="n">kpoints_generator</span><span class="p">(</span><span class="n">dim_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                        <span class="n">k_vec</span><span class="p">,</span> <span class="n">k_dist</span><span class="p">,</span> <span class="n">k_node</span><span class="p">,</span> <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">kpts</span><span class="o">.</span><span class="n">k_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                        <span class="c1"># build crystal structure</span>
                        <span class="n">latt</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">*</span><span class="n">au2ang</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">*</span><span class="n">au2ang</span>
                        <span class="n">species</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
                        <span class="n">struct</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span><span class="n">lattice</span><span class="o">=</span><span class="n">latt</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="p">[</span><span class="n">Element</span><span class="o">.</span><span class="n">from_Z</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">item</span><span class="p">())</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">species</span><span class="p">],</span> <span class="n">coords</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="c1"># Initialize k_path and label</span>
                        <span class="n">kpath_seek</span> <span class="o">=</span> <span class="n">KPathSeek</span><span class="p">(</span><span class="n">structure</span> <span class="o">=</span> <span class="n">struct</span><span class="p">)</span>
                        <span class="n">klabels</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">lbs</span> <span class="ow">in</span> <span class="n">kpath_seek</span><span class="o">.</span><span class="n">kpath</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]:</span>
                            <span class="n">klabels</span> <span class="o">+=</span> <span class="n">lbs</span>
                        <span class="c1"># remove adjacent duplicates   </span>
                        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">klabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">klabels</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="n">klabels</span> <span class="o">=</span> <span class="n">res</span>
                        <span class="n">k_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">kpath_seek</span><span class="o">.</span><span class="n">kpath</span><span class="p">[</span><span class="s1">&#39;kpoints&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">klabels</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">kpts</span><span class="o">=</span><span class="n">kpoints_generator</span><span class="p">(</span><span class="n">dim_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                            <span class="n">k_vec</span><span class="p">,</span> <span class="n">k_dist</span><span class="p">,</span> <span class="n">k_node</span><span class="p">,</span> <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">kpts</span><span class="o">.</span><span class="n">k_path</span><span class="p">(</span><span class="n">k_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">lat_per_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">k_vec</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span> <span class="c1">#(-1, 1)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lat_per_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span> <span class="c1">#(-1, 1)</span>
                    <span class="n">k_vec</span> <span class="o">=</span> <span class="n">k_vec</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lat_per_inv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:])</span> <span class="c1"># shape (nk,1,3)</span>
                    <span class="n">k_vec</span> <span class="o">=</span> <span class="n">k_vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># shape (nk, 3)</span>
                    <span class="n">k_vec</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">k_vec</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">Hon</span><span class="p">)</span>
                    <span class="n">k_vecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_vec</span><span class="p">)</span>  
                <span class="n">data</span><span class="o">.</span><span class="n">k_vecs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">k_vecs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_reciprocal_values</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_only</span><span class="p">:</span>
                        <span class="n">band_energy</span><span class="p">,</span> <span class="n">wavefunction</span><span class="p">,</span> <span class="n">HK</span><span class="p">,</span> <span class="n">SK</span><span class="p">,</span> <span class="n">dSK</span><span class="p">,</span> <span class="n">gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_band_energy</span><span class="p">(</span><span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="n">H_sym</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">band_energy</span><span class="p">,</span> <span class="n">wavefunction</span><span class="p">,</span> <span class="n">HK</span><span class="p">,</span> <span class="n">SK</span><span class="p">,</span> <span class="n">dSK</span><span class="p">,</span> <span class="n">gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_band_energy_debug</span><span class="p">(</span><span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">,</span> <span class="n">Son</span><span class="p">,</span> <span class="n">Soff</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="n">H_sym</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">band_energy</span><span class="p">,</span> <span class="n">wavefunction</span><span class="p">,</span> <span class="n">gap</span><span class="p">,</span> <span class="n">H_sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_band_energy</span><span class="p">(</span><span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">band_energy</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">wavefunction</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">band_gap</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">H_sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_band_energy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">band_energy</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">wavefunction</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">gap</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">H_sym</span> <span class="o">=</span> <span class="kc">None</span>
                      
        <span class="c1"># Combining on-site and off-site Hamiltonians</span>
        <span class="c1"># openmx</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;openmx&#39;</span><span class="p">,</span><span class="s1">&#39;pasp&#39;</span><span class="p">,</span> <span class="s1">&#39;siesta&#39;</span><span class="p">,</span> <span class="s1">&#39;abacus&#39;</span><span class="p">]:</span>                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_constrained</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_point_shift</span><span class="p">:</span>
                        <span class="c1"># calculate miu</span>
                        <span class="n">S</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">overlap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>                        
                        <span class="n">S_soc</span> <span class="o">=</span> <span class="n">blockwise_2x2_concat</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">S</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">S</span><span class="p">),</span> <span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">sum_S_soc</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">S</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">])</span>                        
                        <span class="n">miu_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extract_elements_above_threshold</span><span class="p">(</span><span class="n">S_soc</span><span class="p">,</span> <span class="n">Hsoc_real</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">hamiltonian_real</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">))</span><span class="o">/</span><span class="n">sum_S_soc</span>
                        <span class="c1"># shift Hamiltonian and band_energy</span>
                        <span class="n">Hsoc_real</span> <span class="o">=</span> <span class="n">Hsoc_real</span><span class="o">-</span><span class="n">miu_real</span><span class="o">*</span><span class="n">S_soc</span>
                        <span class="n">Hsoc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">Hsoc_real</span><span class="p">,</span> <span class="n">Hsoc_imag</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">band_energy</span> <span class="o">=</span> <span class="n">band_energy</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">band_energy</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">band_energy</span><span class="p">)</span> <span class="k">if</span> <span class="n">band_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">band_energy</span>
                    
                    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hamiltonian&#39;</span><span class="p">:</span> <span class="n">Hsoc</span><span class="p">,</span> <span class="s1">&#39;hamiltonian_real&#39;</span><span class="p">:</span><span class="n">Hsoc_real</span><span class="p">,</span> <span class="s1">&#39;hamiltonian_imag&#39;</span><span class="p">:</span><span class="n">Hsoc_imag</span><span class="p">,</span> 
                              <span class="s1">&#39;band_energy&#39;</span><span class="p">:</span> <span class="n">band_energy</span><span class="p">,</span> <span class="s1">&#39;wavefunction&#39;</span><span class="p">:</span> <span class="n">wavefunction</span><span class="p">}</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nonzero_mask_tensor</span><span class="p">:</span>
                        <span class="n">mask_real_imag</span><span class="p">,</span> <span class="n">mask_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_tensor_builder_soc</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;mask_real_imag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_real_imag</span>
                    
                <span class="k">else</span><span class="p">:</span> <span class="c1"># collinear_spin</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_point_shift</span><span class="p">:</span>
                        <span class="c1"># calculate miu</span>
                        <span class="n">S</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">overlap</span>
                        <span class="n">S_col</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># (Nbatchs, 2, nao_max**2)</span>
                        <span class="n">sum_S_col</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">S</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">])</span> 
                        <span class="n">miu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extract_elements_above_threshold</span><span class="p">(</span><span class="n">S_col</span><span class="p">,</span> <span class="n">Hcol</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">))</span><span class="o">/</span><span class="n">sum_S_col</span>
                        <span class="c1"># shift Hamiltonian and band_energy</span>
                        <span class="n">Hcol</span> <span class="o">=</span> <span class="n">Hcol</span> <span class="o">-</span> <span class="n">miu</span><span class="o">*</span><span class="n">S_col</span>
                        <span class="n">band_energy</span> <span class="o">=</span> <span class="n">band_energy</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">band_energy</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">band_energy</span><span class="p">)</span> <span class="k">if</span> <span class="n">band_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">band_energy</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hamiltonian&#39;</span><span class="p">:</span> <span class="n">Hcol</span><span class="p">,</span> <span class="s1">&#39;band_energy&#39;</span><span class="p">:</span> <span class="n">band_energy</span><span class="p">,</span> <span class="s1">&#39;wavefunction&#39;</span><span class="p">:</span> <span class="n">wavefunction</span><span class="p">}</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nonzero_mask_tensor</span><span class="p">:</span>
                        <span class="n">mask_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_tensor_builder_col</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_all</span>             
            <span class="k">else</span><span class="p">:</span>
                <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_onsite_and_offsite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Hon</span><span class="p">,</span> <span class="n">Hoff</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_point_shift</span><span class="p">:</span>
                    <span class="c1"># calculate miu</span>
                    <span class="n">S</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">overlap</span>  
                    <span class="n">sum_S</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">S</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">])</span> 
                    <span class="n">miu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extract_elements_above_threshold</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">H</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">))</span><span class="o">/</span><span class="n">sum_S</span>
                    <span class="c1"># shift Hamiltonian and band_energy</span>
                    <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">-</span><span class="n">miu</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">overlap</span>
                    <span class="n">band_energy</span> <span class="o">=</span> <span class="n">band_energy</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">band_energy</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">band_energy</span><span class="p">)</span> <span class="k">if</span> <span class="n">band_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">band_energy</span>                
                
                <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hamiltonian&#39;</span><span class="p">:</span> <span class="n">H</span><span class="p">,</span> <span class="s1">&#39;band_energy&#39;</span><span class="p">:</span> <span class="n">band_energy</span><span class="p">,</span> <span class="s1">&#39;wavefunction&#39;</span><span class="p">:</span> <span class="n">wavefunction</span><span class="p">,</span> <span class="s1">&#39;band_gap&#39;</span><span class="p">:</span><span class="n">gap</span><span class="p">,</span> <span class="s1">&#39;H_sym&#39;</span><span class="p">:</span> <span class="n">H_sym</span><span class="p">}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_reciprocal_values</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;HK&#39;</span><span class="p">:</span><span class="n">HK</span><span class="p">,</span> <span class="s1">&#39;SK&#39;</span><span class="p">:</span><span class="n">SK</span><span class="p">,</span> <span class="s1">&#39;dSK&#39;</span><span class="p">:</span> <span class="n">dSK</span><span class="p">})</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nonzero_mask_tensor</span><span class="p">:</span>
                    <span class="n">mask_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_tensor_builder</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_all</span>
                
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_only</span><span class="p">:</span>                
            <span class="c1"># openmx</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;openmx&#39;</span><span class="p">,</span><span class="s1">&#39;pasp&#39;</span><span class="p">,</span> <span class="s1">&#39;siesta&#39;</span><span class="p">,</span><span class="s1">&#39;abacus&#39;</span><span class="p">]:</span>
                <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_onsite_and_offsite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Son</span><span class="p">,</span> <span class="n">Soff</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;overlap&#39;</span><span class="p">:</span> <span class="n">S</span><span class="p">})</span>
        
        <span class="k">return</span> <span class="n">result</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2025, HamGNN Team。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>